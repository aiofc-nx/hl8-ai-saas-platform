# æœ€ä½³å®è·µæ¦‚è¿°

> **ç‰ˆæœ¬**: 1.0.0 | **åˆ›å»ºæ—¥æœŸ**: 2025-01-27 | **æ¨¡å—**: æ¶æ„è®¾è®¡æ–‡æ¡£

---

## ğŸ“‹ ç›®å½•

- [1. æœ€ä½³å®è·µæ¦‚è¿°](#1-æœ€ä½³å®è·µæ¦‚è¿°)
- [2. æ¶æ„è®¾è®¡æœ€ä½³å®è·µ](#2-æ¶æ„è®¾è®¡æœ€ä½³å®è·µ)
- [3. ä»£ç è´¨é‡æœ€ä½³å®è·µ](#3-ä»£ç è´¨é‡æœ€ä½³å®è·µ)
- [4. æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ](#4-æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ)
- [5. å®‰å…¨æœ€ä½³å®è·µ](#5-å®‰å…¨æœ€ä½³å®è·µ)
- [6. æµ‹è¯•æœ€ä½³å®è·µ](#6-æµ‹è¯•æœ€ä½³å®è·µ)

---

## 1. æœ€ä½³å®è·µæ¦‚è¿°

### 1.1 æœ€ä½³å®è·µç›®æ ‡

HL8 SAASå¹³å°çš„æœ€ä½³å®è·µæ—¨åœ¨ç¡®ä¿ï¼š

- **ä»£ç è´¨é‡**: é«˜è´¨é‡ã€å¯ç»´æŠ¤çš„ä»£ç 
- **ç³»ç»Ÿæ€§èƒ½**: é«˜æ€§èƒ½ã€å¯æ‰©å±•çš„ç³»ç»Ÿ
- **å®‰å…¨æ€§**: å®‰å…¨å¯é çš„æ•°æ®å¤„ç†
- **å¯æµ‹è¯•æ€§**: æ˜“äºæµ‹è¯•å’ŒéªŒè¯
- **å¯ç»´æŠ¤æ€§**: æ˜“äºç†è§£å’Œä¿®æ”¹

### 1.2 æœ€ä½³å®è·µåˆ†ç±»

#### 1.2.1 æ¶æ„è®¾è®¡æœ€ä½³å®è·µ

- **åˆ†å±‚æ¶æ„**: æ¸…æ™°çš„å±‚æ¬¡åˆ†ç¦»
- **ä¾èµ–ç®¡ç†**: åˆç†çš„ä¾èµ–å…³ç³»
- **æ¥å£è®¾è®¡**: æ¸…æ™°çš„æ¥å£å®šä¹‰
- **æ¨¡å—åŒ–**: é«˜å†…èšä½è€¦åˆ

#### 1.2.2 ä»£ç è´¨é‡æœ€ä½³å®è·µ

- **å‘½åè§„èŒƒ**: æœ‰æ„ä¹‰çš„å‘½å
- **æ³¨é‡Šè§„èŒƒ**: å®Œæ•´çš„æ–‡æ¡£æ³¨é‡Š
- **ç±»å‹å®‰å…¨**: TypeScriptç±»å‹ç³»ç»Ÿ
- **é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†

#### 1.2.3 æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ

- **æ•°æ®åº“ä¼˜åŒ–**: æŸ¥è¯¢ä¼˜åŒ–å’Œç´¢å¼•
- **ç¼“å­˜ç­–ç•¥**: åˆç†çš„ç¼“å­˜ä½¿ç”¨
- **å¼‚æ­¥å¤„ç†**: å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼
- **èµ„æºç®¡ç†**: å†…å­˜å’Œè¿æ¥ç®¡ç†

#### 1.2.4 å®‰å…¨æœ€ä½³å®è·µ

- **è¾“å…¥éªŒè¯**: ä¸¥æ ¼çš„æ•°æ®éªŒè¯
- **æƒé™æ§åˆ¶**: ç»†ç²’åº¦çš„æƒé™ç®¡ç†
- **æ•°æ®éš”ç¦»**: å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»
- **æ•æ„Ÿä¿¡æ¯**: å®‰å…¨çš„ä¿¡æ¯å¤„ç†

#### 1.2.5 æµ‹è¯•æœ€ä½³å®è·µ

- **æµ‹è¯•ç­–ç•¥**: å®Œæ•´çš„æµ‹è¯•è¦†ç›–
- **æµ‹è¯•ç»„ç»‡**: æ¸…æ™°çš„æµ‹è¯•ç»“æ„
- **æµ‹è¯•æ•°æ®**: åˆç†çš„æµ‹è¯•æ•°æ®
- **æµ‹è¯•ç»´æŠ¤**: æŒç»­çš„æµ‹è¯•æ›´æ–°

---

## 2. æ¶æ„è®¾è®¡æœ€ä½³å®è·µ

### 2.1 åˆ†å±‚æ¶æ„æœ€ä½³å®è·µ

#### 2.1.1 é¢†åŸŸå±‚è®¾è®¡

**âœ… å¥½çš„åšæ³•**:

```typescript
/**
 * ç”¨æˆ·èšåˆæ ¹
 * 
 * @description ç”¨æˆ·èšåˆæ ¹ï¼Œç®¡ç†ç”¨æˆ·ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘
 * éµå¾ªå……è¡€æ¨¡å‹ï¼ŒåŒ…å«å®Œæ•´çš„ä¸šåŠ¡è¡Œä¸º
 */
export class User extends AggregateRoot {
  private _email: Email;
  private _status: UserStatus;
  
  constructor(
    id: UserId,
    email: Email,
    username: Username
  ) {
    super(id);
    this._email = email;
    this._status = UserStatus.PENDING;
    
    // å‘å¸ƒé¢†åŸŸäº‹ä»¶
    this.addDomainEvent(new UserCreatedEvent(this.id, this.email));
  }
  
  /**
   * æ›´æ”¹ç”¨æˆ·é‚®ç®±
   * 
   * @param newEmail æ–°é‚®ç®±
   * @throws UserNotActiveException ç”¨æˆ·æœªæ¿€æ´»æ—¶æŠ›å‡º
   */
  public changeEmail(newEmail: Email): void {
    // ä¸šåŠ¡è§„åˆ™éªŒè¯
    if (!this.isActive()) {
      throw new UserNotActiveException(this.id);
    }
    
    if (this._email.equals(newEmail)) {
      return; // ç›¸åŒé‚®ç®±ï¼Œæ— éœ€æ›´æ”¹
    }
    
    // æ‰§è¡Œé‚®ç®±æ›´æ”¹
    const oldEmail = this._email;
    this._email = newEmail;
    
    // å‘å¸ƒé¢†åŸŸäº‹ä»¶
    this.addDomainEvent(new UserEmailChangedEvent(this.id, oldEmail, newEmail));
  }
  
  /**
   * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ¿€æ´»
   * 
   * @returns æ˜¯å¦æ¿€æ´»
   */
  public isActive(): boolean {
    return this._status === UserStatus.ACTIVE;
  }
}
```

**âŒ é¿å…çš„åšæ³•**:

```typescript
// è´«è¡€æ¨¡å‹ - åªæœ‰getter/setterï¼Œæ²¡æœ‰ä¸šåŠ¡é€»è¾‘
export class User {
  public email: string;
  public status: string;
  
  public setEmail(email: string): void {
    this.email = email;
  }
  
  public getEmail(): string {
    return this.email;
  }
  
  // æ²¡æœ‰ä¸šåŠ¡é€»è¾‘ï¼Œåªæ˜¯æ•°æ®å®¹å™¨
}
```

#### 2.1.2 åº”ç”¨å±‚è®¾è®¡

**âœ… å¥½çš„åšæ³•**:

```typescript
/**
 * åˆ›å»ºç”¨æˆ·ç”¨ä¾‹
 * 
 * @description åˆ›å»ºç”¨æˆ·çš„ä¸šåŠ¡ç”¨ä¾‹
 * åè°ƒé¢†åŸŸå±‚å’ŒåŸºç¡€è®¾æ–½å±‚ï¼Œå®ç°å®Œæ•´çš„ä¸šåŠ¡æµç¨‹
 */
export class CreateUserUseCase extends BaseUseCase {
  constructor(
    private readonly userRepository: IUserRepository,
    private readonly eventBus: IEventBus,
    private readonly emailService: IEmailService
  ) {
    super();
  }
  
  /**
   * æ‰§è¡Œåˆ›å»ºç”¨æˆ·ç”¨ä¾‹
   * 
   * @param request åˆ›å»ºç”¨æˆ·è¯·æ±‚
   * @returns åˆ›å»ºç”¨æˆ·å“åº”
   */
  public async execute(request: CreateUserRequest): Promise<CreateUserResponse> {
    // 1. éªŒè¯è¾“å…¥
    this.validateRequest(request);
    
    // 2. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
    await this.checkUserExists(request.email, request.username);
    
    // 3. åˆ›å»ºç”¨æˆ·å®ä½“
    const user = this.createUser(request);
    
    // 4. ä¿å­˜ç”¨æˆ·
    await this.userRepository.save(user);
    
    // 5. å‘é€æ¬¢è¿é‚®ä»¶
    await this.sendWelcomeEmail(user);
    
    // 6. å‘å¸ƒé¢†åŸŸäº‹ä»¶
    await this.eventBus.publish(user.getDomainEvents());
    
    return new CreateUserResponse(user.id, user.email, user.username);
  }
  
  private validateRequest(request: CreateUserRequest): void {
    // è¾“å…¥éªŒè¯é€»è¾‘
  }
  
  private async checkUserExists(email: string, username: string): Promise<void> {
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
  }
  
  private createUser(request: CreateUserRequest): User {
    // åˆ›å»ºç”¨æˆ·å®ä½“
  }
  
  private async sendWelcomeEmail(user: User): Promise<void> {
    // å‘é€æ¬¢è¿é‚®ä»¶
  }
}
```

**âŒ é¿å…çš„åšæ³•**:

```typescript
// ç›´æ¥åœ¨æ§åˆ¶å™¨ä¸­å¤„ç†ä¸šåŠ¡é€»è¾‘
@Controller('users')
export class UserController {
  @Post()
  public async createUser(@Body() request: CreateUserRequest): Promise<any> {
    // ç›´æ¥åœ¨æ§åˆ¶å™¨ä¸­å¤„ç†ä¸šåŠ¡é€»è¾‘ - è¿ååˆ†å±‚æ¶æ„
    const user = new User();
    user.email = request.email;
    user.username = request.username;
    
    // ç›´æ¥è°ƒç”¨æ•°æ®åº“ - è¿åä¾èµ–å…³ç³»
    await this.database.save(user);
    
    return { success: true };
  }
}
```

### 2.2 ä¾èµ–ç®¡ç†æœ€ä½³å®è·µ

#### 2.2.1 ä¾èµ–æ³¨å…¥

**âœ… å¥½çš„åšæ³•**:

```typescript
/**
 * ç”¨æˆ·æœåŠ¡
 * 
 * @description ç”¨æˆ·åº”ç”¨æœåŠ¡
 * é€šè¿‡ä¾èµ–æ³¨å…¥ç®¡ç†ä¾èµ–å…³ç³»
 */
@Injectable()
export class UserService {
  constructor(
    private readonly userRepository: IUserRepository,
    private readonly eventBus: IEventBus,
    private readonly emailService: IEmailService,
    private readonly passwordService: IPasswordService
  ) {}
  
  public async createUser(request: CreateUserRequest): Promise<CreateUserResponse> {
    // ä½¿ç”¨æ³¨å…¥çš„ä¾èµ–
    const user = await this.userRepository.findByEmail(request.email);
    if (user) {
      throw new DuplicateUserException('ç”¨æˆ·å·²å­˜åœ¨');
    }
    
    const newUser = User.create(request.email, request.username);
    await this.userRepository.save(newUser);
    
    await this.eventBus.publish(newUser.getDomainEvents());
    
    return new CreateUserResponse(newUser.id, newUser.email);
  }
}
```

**âŒ é¿å…çš„åšæ³•**:

```typescript
// ç›´æ¥å®ä¾‹åŒ–ä¾èµ– - éš¾ä»¥æµ‹è¯•å’Œç»´æŠ¤
export class UserService {
  private userRepository = new UserRepository();
  private eventBus = new EventBus();
  private emailService = new EmailService();
  
  public async createUser(request: CreateUserRequest): Promise<CreateUserResponse> {
    // ä½¿ç”¨ç¡¬ç¼–ç çš„ä¾èµ–
  }
}
```

#### 2.2.2 æ¥å£è®¾è®¡

**âœ… å¥½çš„åšæ³•**:

```typescript
/**
 * ç”¨æˆ·ä»“å‚¨æ¥å£
 * 
 * @description ç”¨æˆ·æ•°æ®è®¿é—®æ¥å£
 * å®šä¹‰æ¸…æ™°çš„æ•°æ®è®¿é—®å¥‘çº¦
 */
export interface IUserRepository {
  /**
   * ä¿å­˜ç”¨æˆ·
   * 
   * @param user ç”¨æˆ·å®ä½“
   * @throws DatabaseException æ•°æ®åº“å¼‚å¸¸æ—¶æŠ›å‡º
   */
  save(user: User): Promise<void>;
  
  /**
   * æ ¹æ®IDæŸ¥æ‰¾ç”¨æˆ·
   * 
   * @param id ç”¨æˆ·ID
   * @returns ç”¨æˆ·å®ä½“æˆ–null
   * @throws DatabaseException æ•°æ®åº“å¼‚å¸¸æ—¶æŠ›å‡º
   */
  findById(id: UserId): Promise<User | null>;
  
  /**
   * æ ¹æ®é‚®ç®±æŸ¥æ‰¾ç”¨æˆ·
   * 
   * @param email é‚®ç®±åœ°å€
   * @returns ç”¨æˆ·å®ä½“æˆ–null
   * @throws DatabaseException æ•°æ®åº“å¼‚å¸¸æ—¶æŠ›å‡º
   */
  findByEmail(email: Email): Promise<User | null>;
  
  /**
   * åˆ é™¤ç”¨æˆ·
   * 
   * @param id ç”¨æˆ·ID
   * @throws DatabaseException æ•°æ®åº“å¼‚å¸¸æ—¶æŠ›å‡º
   */
  delete(id: UserId): Promise<void>;
}
```

**âŒ é¿å…çš„åšæ³•**:

```typescript
// æ¥å£å®šä¹‰ä¸æ¸…æ™°ï¼Œç¼ºå°‘æ–‡æ¡£
export interface IUserRepository {
  save(user: any): Promise<any>;
  findById(id: any): Promise<any>;
  findByEmail(email: any): Promise<any>;
  delete(id: any): Promise<any>;
}
```

---

## 3. ä»£ç è´¨é‡æœ€ä½³å®è·µ

### 3.1 å‘½åè§„èŒƒ

#### 3.1.1 ç±»å‘½å

**âœ… å¥½çš„åšæ³•**:

```typescript
// ä½¿ç”¨æœ‰æ„ä¹‰çš„ç±»å
export class UserRegistrationService { }
export class OrderProcessingUseCase { }
export class EmailNotificationHandler { }
export class DatabaseConnectionManager { }
```

**âŒ é¿å…çš„åšæ³•**:

```typescript
// ä½¿ç”¨æ— æ„ä¹‰çš„ç±»å
export class Service { }
export class Handler { }
export class Manager { }
export class Util { }
```

#### 3.1.2 æ–¹æ³•å‘½å

**âœ… å¥½çš„åšæ³•**:

```typescript
export class User {
  /**
   * æ¿€æ´»ç”¨æˆ·
   */
  public activate(): void { }
  
  /**
   * æ›´æ”¹ç”¨æˆ·é‚®ç®±
   */
  public changeEmail(newEmail: Email): void { }
  
  /**
   * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ¿€æ´»
   */
  public isActive(): boolean { }
  
  /**
   * æ›´æ–°ç”¨æˆ·èµ„æ–™
   */
  public updateProfile(profile: UserProfile): void { }
}
```

**âŒ é¿å…çš„åšæ³•**:

```typescript
export class User {
  public doSomething(): void { }
  public process(): void { }
  public handle(): void { }
  public execute(): void { }
}
```

#### 3.1.3 å˜é‡å‘½å

**âœ… å¥½çš„åšæ³•**:

```typescript
// ä½¿ç”¨æœ‰æ„ä¹‰çš„å˜é‡å
const userEmail = 'user@example.com';
const isUserActive = user.status === UserStatus.ACTIVE;
const userRegistrationDate = new Date();
const maxRetryAttempts = 3;
```

**âŒ é¿å…çš„åšæ³•**:

```typescript
// ä½¿ç”¨æ— æ„ä¹‰çš„å˜é‡å
const email = 'user@example.com';
const flag = user.status === UserStatus.ACTIVE;
const date = new Date();
const count = 3;
```

### 3.2 æ³¨é‡Šè§„èŒƒ

#### 3.2.1 TSDocæ³¨é‡Š

**âœ… å¥½çš„åšæ³•**:

```typescript
/**
 * ç”¨æˆ·å®ä½“
 * 
 * @description ç”¨æˆ·ä¸šåŠ¡å®ä½“ï¼ŒåŒ…å«ç”¨æˆ·ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘
 * éµå¾ªå……è¡€æ¨¡å‹è®¾è®¡ï¼Œå®ä½“åŒ…å«ä¸šåŠ¡é€»è¾‘è€Œä¸ä»…ä»…æ˜¯æ•°æ®å®¹å™¨
 * 
 * @example
 * ```typescript
 * const user = new User(
 *   new UserId('user-123'),
 *   new Email('user@example.com'),
 *   new Username('john_doe')
 * );
 * 
 * user.changeEmail(new Email('new@example.com'));
 * user.activate();
 * ```
 */
export class User extends BaseEntity {
  /**
   * æ›´æ”¹ç”¨æˆ·é‚®ç®±
   * 
   * @param newEmail æ–°é‚®ç®±åœ°å€
   * @throws InvalidEmailException é‚®ç®±æ ¼å¼æ— æ•ˆæ—¶æŠ›å‡º
   * @throws UserNotActiveException ç”¨æˆ·æœªæ¿€æ´»æ—¶æŠ›å‡º
   * 
   * @example
   * ```typescript
   * user.changeEmail(new Email('new@example.com'));
   * ```
   */
  public changeEmail(newEmail: Email): void {
    // å®ç°é€»è¾‘
  }
}
```

**âŒ é¿å…çš„åšæ³•**:

```typescript
// ç¼ºå°‘æ³¨é‡Šæˆ–æ³¨é‡Šä¸å®Œæ•´
export class User extends BaseEntity {
  public changeEmail(newEmail: Email): void {
    // æ›´æ”¹é‚®ç®±
  }
}
```

#### 3.2.2 ä¸šåŠ¡è§„åˆ™æ³¨é‡Š

**âœ… å¥½çš„åšæ³•**:

```typescript
/**
 * ç”¨æˆ·æ¿€æ´»
 * 
 * @description æ¿€æ´»ç”¨æˆ·è´¦æˆ·ï¼Œå…è®¸ç”¨æˆ·æ­£å¸¸ä½¿ç”¨ç³»ç»Ÿ
 * 
 * ## ä¸šåŠ¡è§„åˆ™
 * 
 * ### å‰ç½®æ¡ä»¶
 * - ç”¨æˆ·å¿…é¡»å¤„äºPENDINGçŠ¶æ€
 * - ç”¨æˆ·å¿…é¡»å®Œæˆé‚®ç®±éªŒè¯
 * 
 * ### åç½®æ¡ä»¶
 * - ç”¨æˆ·çŠ¶æ€å˜æ›´ä¸ºACTIVE
 * - å‘å¸ƒç”¨æˆ·æ¿€æ´»äº‹ä»¶
 * - å‘é€æ¿€æ´»æˆåŠŸé€šçŸ¥
 * 
 * ### å¼‚å¸¸æƒ…å†µ
 * - ç”¨æˆ·å·²æ¿€æ´»ï¼šæŠ›å‡ºUserAlreadyActiveException
 * - é‚®ç®±æœªéªŒè¯ï¼šæŠ›å‡ºEmailNotVerifiedException
 * 
 * @throws UserAlreadyActiveException ç”¨æˆ·å·²æ¿€æ´»æ—¶æŠ›å‡º
 * @throws EmailNotVerifiedException é‚®ç®±æœªéªŒè¯æ—¶æŠ›å‡º
 */
public activate(): void {
  // å®ç°é€»è¾‘
}
```

### 3.3 ç±»å‹å®‰å…¨

#### 3.3.1 å¼ºç±»å‹å®šä¹‰

**âœ… å¥½çš„åšæ³•**:

```typescript
// ä½¿ç”¨å¼ºç±»å‹å®šä¹‰
export interface CreateUserRequest {
  readonly email: string;
  readonly username: string;
  readonly password: string;
  readonly profile?: UserProfile;
}

export interface CreateUserResponse {
  readonly userId: string;
  readonly email: string;
  readonly username: string;
  readonly status: UserStatus;
}

// ä½¿ç”¨å€¼å¯¹è±¡
export class Email extends BaseValueObject {
  constructor(private readonly value: string) {
    super();
    this.validateEmail(value);
  }
  
  public get value(): string {
    return this._value;
  }
}
```

**âŒ é¿å…çš„åšæ³•**:

```typescript
// ä½¿ç”¨anyç±»å‹
export interface CreateUserRequest {
  email: any;
  username: any;
  password: any;
  profile?: any;
}

// ä½¿ç”¨åŸå§‹ç±»å‹
export class User {
  public email: string;
  public username: string;
  public password: string;
}
```

#### 3.3.2 ç±»å‹å®ˆå«

**âœ… å¥½çš„åšæ³•**:

```typescript
/**
 * ç±»å‹å®ˆå«ï¼šæ£€æŸ¥æ˜¯å¦ä¸ºç”¨æˆ·å®ä½“
 * 
 * @param obj å¾…æ£€æŸ¥çš„å¯¹è±¡
 * @returns æ˜¯å¦ä¸ºç”¨æˆ·å®ä½“
 */
export function isUser(obj: any): obj is User {
  return obj instanceof User;
}

/**
 * ç±»å‹å®ˆå«ï¼šæ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„é‚®ç®±
 * 
 * @param email å¾…æ£€æŸ¥çš„é‚®ç®±
 * @returns æ˜¯å¦ä¸ºæœ‰æ•ˆçš„é‚®ç®±
 */
export function isValidEmail(email: string): email is string {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}

// ä½¿ç”¨ç±»å‹å®ˆå«
if (isUser(user)) {
  // TypeScriptçŸ¥é“useræ˜¯Userç±»å‹
  user.activate();
}

if (isValidEmail(email)) {
  // TypeScriptçŸ¥é“emailæ˜¯æœ‰æ•ˆçš„é‚®ç®±å­—ç¬¦ä¸²
  const emailObj = new Email(email);
}
```

### 3.4 é”™è¯¯å¤„ç†

#### 3.4.1 ç»Ÿä¸€å¼‚å¸¸å¤„ç†

**âœ… å¥½çš„åšæ³•**:

```typescript
/**
 * ä¸šåŠ¡å¼‚å¸¸åŸºç±»
 * 
 * @description æ‰€æœ‰ä¸šåŠ¡å¼‚å¸¸çš„åŸºç±»
 * æä¾›ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
 */
export abstract class BusinessException extends Error {
  constructor(
    message: string,
    public readonly code: string,
    public readonly details?: Record<string, any>
  ) {
    super(message);
    this.name = this.constructor.name;
  }
}

/**
 * ç”¨æˆ·ä¸å­˜åœ¨å¼‚å¸¸
 * 
 * @description å½“ç”¨æˆ·ä¸å­˜åœ¨æ—¶æŠ›å‡º
 */
export class UserNotFoundException extends BusinessException {
  constructor(userId: string) {
    super(`ç”¨æˆ·ä¸å­˜åœ¨: ${userId}`, 'USER_NOT_FOUND', { userId });
  }
}

/**
 * ç”¨æˆ·å·²å­˜åœ¨å¼‚å¸¸
 * 
 * @description å½“ç”¨æˆ·å·²å­˜åœ¨æ—¶æŠ›å‡º
 */
export class DuplicateUserException extends BusinessException {
  constructor(email: string) {
    super(`ç”¨æˆ·å·²å­˜åœ¨: ${email}`, 'DUPLICATE_USER', { email });
  }
}

// ä½¿ç”¨å¼‚å¸¸
export class UserService {
  public async getUser(id: string): Promise<User> {
    const user = await this.userRepository.findById(id);
    if (!user) {
      throw new UserNotFoundException(id);
    }
    return user;
  }
}
```

**âŒ é¿å…çš„åšæ³•**:

```typescript
// ä½¿ç”¨é€šç”¨å¼‚å¸¸
export class UserService {
  public async getUser(id: string): Promise<User> {
    const user = await this.userRepository.findById(id);
    if (!user) {
      throw new Error('ç”¨æˆ·ä¸å­˜åœ¨'); // ç¼ºå°‘å¼‚å¸¸ç±»å‹å’Œè¯¦ç»†ä¿¡æ¯
    }
    return user;
  }
}
```

---

## 4. æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ

### 4.1 æ•°æ®åº“ä¼˜åŒ–

#### 4.1.1 æŸ¥è¯¢ä¼˜åŒ–

**âœ… å¥½çš„åšæ³•**:

```typescript
/**
 * ç”¨æˆ·ä»“å‚¨å®ç°
 * 
 * @description ä¼˜åŒ–çš„ç”¨æˆ·æ•°æ®è®¿é—®å®ç°
 * ä½¿ç”¨ç´¢å¼•å’ŒæŸ¥è¯¢ä¼˜åŒ–æé«˜æ€§èƒ½
 */
export class UserRepository implements IUserRepository {
  /**
   * æ ¹æ®é‚®ç®±æŸ¥æ‰¾ç”¨æˆ·ï¼ˆä½¿ç”¨ç´¢å¼•ï¼‰
   * 
   * @param email é‚®ç®±åœ°å€
   * @returns ç”¨æˆ·å®ä½“æˆ–null
   */
  public async findByEmail(email: Email): Promise<User | null> {
    // ä½¿ç”¨ç´¢å¼•æŸ¥è¯¢ï¼Œé¿å…å…¨è¡¨æ‰«æ
    const userEntity = await this.entityManager.findOne(UserEntity, {
      email: email.value,
      tenantId: this.isolationContext.tenantId.value
    }, {
      indexHint: 'idx_user_email_tenant' // ä½¿ç”¨ç´¢å¼•æç¤º
    });
    
    return userEntity ? this.mapToDomain(userEntity) : null;
  }
  
  /**
   * åˆ†é¡µæŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
   * 
   * @param page é¡µç 
   * @param limit æ¯é¡µæ•°é‡
   * @returns ç”¨æˆ·åˆ—è¡¨
   */
  public async findUsers(page: number, limit: number): Promise<User[]> {
    const offset = (page - 1) * limit;
    
    const userEntities = await this.entityManager.find(UserEntity, {
      tenantId: this.isolationContext.tenantId.value
    }, {
      limit,
      offset,
      orderBy: { createdAt: 'DESC' } // æŒ‰åˆ›å»ºæ—¶é—´å€’åº
    });
    
    return userEntities.map(entity => this.mapToDomain(entity));
  }
}
```

**âŒ é¿å…çš„åšæ³•**:

```typescript
// ä½æ•ˆçš„æŸ¥è¯¢å®ç°
export class UserRepository implements IUserRepository {
  public async findByEmail(email: Email): Promise<User | null> {
    // å…¨è¡¨æ‰«æï¼Œæ²¡æœ‰ä½¿ç”¨ç´¢å¼•
    const users = await this.entityManager.find(UserEntity, {});
    return users.find(user => user.email === email.value);
  }
  
  public async findUsers(page: number, limit: number): Promise<User[]> {
    // æ²¡æœ‰åˆ†é¡µï¼Œå¯èƒ½è¿”å›å¤§é‡æ•°æ®
    const users = await this.entityManager.find(UserEntity, {});
    return users.slice((page - 1) * limit, page * limit);
  }
}
```

#### 4.1.2 è¿æ¥æ± ä¼˜åŒ–

**âœ… å¥½çš„åšæ³•**:

```typescript
/**
 * æ•°æ®åº“é…ç½®
 * 
 * @description ä¼˜åŒ–çš„æ•°æ®åº“è¿æ¥æ± é…ç½®
 * æ ¹æ®ç³»ç»Ÿè´Ÿè½½è°ƒæ•´è¿æ¥æ± å‚æ•°
 */
export const databaseConfig = {
  type: 'postgresql',
  host: process.env.DB_HOST,
  port: parseInt(process.env.DB_PORT || '5432'),
  database: process.env.DB_DATABASE,
  username: process.env.DB_USERNAME,
  password: process.env.DB_PASSWORD,
  pool: {
    min: parseInt(process.env.DB_POOL_MIN || '5'),
    max: parseInt(process.env.DB_POOL_MAX || '20'),
    idleTimeoutMillis: parseInt(process.env.DB_IDLE_TIMEOUT || '30000'),
    acquireTimeoutMillis: parseInt(process.env.DB_ACQUIRE_TIMEOUT || '60000')
  },
  options: {
    enableArithAbort: true,
    trustServerCertificate: true
  }
};
```

### 4.2 ç¼“å­˜ç­–ç•¥

#### 4.2.1 ç¼“å­˜è®¾è®¡

**âœ… å¥½çš„åšæ³•**:

```typescript
/**
 * ç”¨æˆ·ç¼“å­˜æœåŠ¡
 * 
 * @description ç”¨æˆ·æ•°æ®ç¼“å­˜æœåŠ¡
 * ä½¿ç”¨å¤šçº§ç¼“å­˜ç­–ç•¥æé«˜æ€§èƒ½
 */
@Injectable()
export class UserCacheService {
  constructor(
    private readonly cache: ICache,
    private readonly userRepository: IUserRepository
  ) {}
  
  /**
   * è·å–ç”¨æˆ·ï¼ˆå¸¦ç¼“å­˜ï¼‰
   * 
   * @param userId ç”¨æˆ·ID
   * @returns ç”¨æˆ·å®ä½“
   */
  public async getUser(userId: string): Promise<User | null> {
    const cacheKey = `user:${userId}`;
    
    // 1. å°è¯•ä»ç¼“å­˜è·å–
    let user = await this.cache.get<User>(cacheKey);
    if (user) {
      return user;
    }
    
    // 2. ä»æ•°æ®åº“è·å–
    user = await this.userRepository.findById(new UserId(userId));
    if (!user) {
      return null;
    }
    
    // 3. å†™å…¥ç¼“å­˜
    await this.cache.set(cacheKey, user, 3600); // 1å°æ—¶TTL
    
    return user;
  }
  
  /**
   * æ›´æ–°ç”¨æˆ·ç¼“å­˜
   * 
   * @param user ç”¨æˆ·å®ä½“
   */
  public async updateUserCache(user: User): Promise<void> {
    const cacheKey = `user:${user.id.value}`;
    await this.cache.set(cacheKey, user, 3600);
  }
  
  /**
   * åˆ é™¤ç”¨æˆ·ç¼“å­˜
   * 
   * @param userId ç”¨æˆ·ID
   */
  public async deleteUserCache(userId: string): Promise<void> {
    const cacheKey = `user:${userId}`;
    await this.cache.delete(cacheKey);
  }
}
```

#### 4.2.2 ç¼“å­˜å¤±æ•ˆç­–ç•¥

**âœ… å¥½çš„åšæ³•**:

```typescript
/**
 * ç”¨æˆ·æœåŠ¡ï¼ˆå¸¦ç¼“å­˜å¤±æ•ˆï¼‰
 * 
 * @description ç”¨æˆ·æœåŠ¡ï¼Œè‡ªåŠ¨å¤„ç†ç¼“å­˜å¤±æ•ˆ
 */
@Injectable()
export class UserService {
  constructor(
    private readonly userRepository: IUserRepository,
    private readonly userCacheService: UserCacheService,
    private readonly eventBus: IEventBus
  ) {}
  
  /**
   * æ›´æ–°ç”¨æˆ·
   * 
   * @param userId ç”¨æˆ·ID
   * @param request æ›´æ–°è¯·æ±‚
   * @returns æ›´æ–°åçš„ç”¨æˆ·
   */
  public async updateUser(userId: string, request: UpdateUserRequest): Promise<User> {
    // 1. è·å–ç”¨æˆ·
    const user = await this.userCacheService.getUser(userId);
    if (!user) {
      throw new UserNotFoundException(userId);
    }
    
    // 2. æ›´æ–°ç”¨æˆ·
    user.updateProfile(request.profile);
    
    // 3. ä¿å­˜åˆ°æ•°æ®åº“
    await this.userRepository.save(user);
    
    // 4. æ›´æ–°ç¼“å­˜
    await this.userCacheService.updateUserCache(user);
    
    // 5. å‘å¸ƒäº‹ä»¶
    await this.eventBus.publish(user.getDomainEvents());
    
    return user;
  }
  
  /**
   * åˆ é™¤ç”¨æˆ·
   * 
   * @param userId ç”¨æˆ·ID
   */
  public async deleteUser(userId: string): Promise<void> {
    // 1. åˆ é™¤æ•°æ®åº“è®°å½•
    await this.userRepository.delete(new UserId(userId));
    
    // 2. åˆ é™¤ç¼“å­˜
    await this.userCacheService.deleteUserCache(userId);
    
    // 3. å‘å¸ƒäº‹ä»¶
    await this.eventBus.publish(new UserDeletedEvent(userId));
  }
}
```

### 4.3 å¼‚æ­¥å¤„ç†

#### 4.3.1 å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼

**âœ… å¥½çš„åšæ³•**:

```typescript
/**
 * ç”¨æˆ·æ³¨å†ŒæœåŠ¡
 * 
 * @description å¼‚æ­¥å¤„ç†ç”¨æˆ·æ³¨å†Œæµç¨‹
 * ä½¿ç”¨Promise.allå¹¶è¡Œå¤„ç†å¤šä¸ªå¼‚æ­¥æ“ä½œ
 */
@Injectable()
export class UserRegistrationService {
  constructor(
    private readonly userRepository: IUserRepository,
    private readonly emailService: IEmailService,
    private readonly smsService: ISmsService,
    private readonly eventBus: IEventBus
  ) {}
  
  /**
   * æ³¨å†Œç”¨æˆ·
   * 
   * @param request æ³¨å†Œè¯·æ±‚
   * @returns æ³¨å†Œç»“æœ
   */
  public async registerUser(request: UserRegistrationRequest): Promise<UserRegistrationResponse> {
    // 1. åˆ›å»ºç”¨æˆ·
    const user = await this.createUser(request);
    
    // 2. å¹¶è¡Œå¤„ç†å¤šä¸ªå¼‚æ­¥æ“ä½œ
    const [emailResult, smsResult, eventResult] = await Promise.all([
      this.sendWelcomeEmail(user),
      this.sendWelcomeSms(user),
      this.publishRegistrationEvent(user)
    ]);
    
    return new UserRegistrationResponse(
      user.id,
      user.email,
      emailResult.success,
      smsResult.success
    );
  }
  
  private async sendWelcomeEmail(user: User): Promise<{ success: boolean }> {
    try {
      await this.emailService.sendWelcomeEmail(user.email);
      return { success: true };
    } catch (error) {
      console.error('å‘é€æ¬¢è¿é‚®ä»¶å¤±è´¥:', error);
      return { success: false };
    }
  }
  
  private async sendWelcomeSms(user: User): Promise<{ success: boolean }> {
    try {
      await this.smsService.sendWelcomeSms(user.phone);
      return { success: true };
    } catch (error) {
      console.error('å‘é€æ¬¢è¿çŸ­ä¿¡å¤±è´¥:', error);
      return { success: false };
    }
  }
  
  private async publishRegistrationEvent(user: User): Promise<void> {
    await this.eventBus.publish(new UserRegisteredEvent(user.id, user.email));
  }
}
```

#### 4.3.2 é”™è¯¯å¤„ç†

**âœ… å¥½çš„åšæ³•**:

```typescript
/**
 * å¼‚æ­¥æ“ä½œé”™è¯¯å¤„ç†
 * 
 * @description å¤„ç†å¼‚æ­¥æ“ä½œä¸­çš„é”™è¯¯
 * ç¡®ä¿éƒ¨åˆ†å¤±è´¥ä¸å½±å“æ•´ä½“æµç¨‹
 */
export class AsyncOperationHandler {
  /**
   * æ‰¹é‡å¤„ç†ç”¨æˆ·æ“ä½œ
   * 
   * @param operations æ“ä½œåˆ—è¡¨
   * @returns å¤„ç†ç»“æœ
   */
  public async batchProcess(operations: AsyncOperation[]): Promise<BatchProcessResult> {
    const results: OperationResult[] = [];
    const errors: OperationError[] = [];
    
    // ä½¿ç”¨Promise.allSettledå¤„ç†éƒ¨åˆ†å¤±è´¥
    const settledResults = await Promise.allSettled(
      operations.map(operation => this.processOperation(operation))
    );
    
    settledResults.forEach((result, index) => {
      if (result.status === 'fulfilled') {
        results.push(result.value);
      } else {
        errors.push({
          operation: operations[index],
          error: result.reason
        });
      }
    });
    
    return new BatchProcessResult(results, errors);
  }
  
  private async processOperation(operation: AsyncOperation): Promise<OperationResult> {
    try {
      const result = await operation.execute();
      return { success: true, data: result };
    } catch (error) {
      throw new OperationException(`æ“ä½œå¤±è´¥: ${operation.name}`, error);
    }
  }
}
```

---

## 5. å®‰å…¨æœ€ä½³å®è·µ

### 5.1 è¾“å…¥éªŒè¯

#### 5.1.1 æ•°æ®éªŒè¯

**âœ… å¥½çš„åšæ³•**:

```typescript
/**
 * ç”¨æˆ·è¾“å…¥éªŒè¯å™¨
 * 
 * @description ä¸¥æ ¼çš„ç”¨æˆ·è¾“å…¥éªŒè¯
 * é˜²æ­¢æ¶æ„è¾“å…¥å’Œæ³¨å…¥æ”»å‡»
 */
export class UserInputValidator {
  /**
   * éªŒè¯ç”¨æˆ·æ³¨å†Œè¾“å…¥
   * 
   * @param input ç”¨æˆ·è¾“å…¥
   * @returns éªŒè¯ç»“æœ
   */
  public validateUserRegistration(input: UserRegistrationInput): ValidationResult {
    const errors: ValidationError[] = [];
    
    // é‚®ç®±éªŒè¯
    if (!this.isValidEmail(input.email)) {
      errors.push(new ValidationError('email', 'é‚®ç®±æ ¼å¼æ— æ•ˆ'));
    }
    
    // ç”¨æˆ·åéªŒè¯
    if (!this.isValidUsername(input.username)) {
      errors.push(new ValidationError('username', 'ç”¨æˆ·åæ ¼å¼æ— æ•ˆ'));
    }
    
    // å¯†ç éªŒè¯
    if (!this.isValidPassword(input.password)) {
      errors.push(new ValidationError('password', 'å¯†ç å¼ºåº¦ä¸è¶³'));
    }
    
    // é˜²æ­¢SQLæ³¨å…¥
    if (this.containsSqlInjection(input.email) || 
        this.containsSqlInjection(input.username)) {
      errors.push(new ValidationError('input', 'è¾“å…¥åŒ…å«éæ³•å­—ç¬¦'));
    }
    
    return new ValidationResult(errors.length === 0, errors);
  }
  
  private isValidEmail(email: string): boolean {
    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    return emailRegex.test(email) && email.length <= 254;
  }
  
  private isValidUsername(username: string): boolean {
    const usernameRegex = /^[a-zA-Z0-9_-]{3,20}$/;
    return usernameRegex.test(username);
  }
  
  private isValidPassword(password: string): boolean {
    // å¯†ç å¼ºåº¦è¦æ±‚ï¼šè‡³å°‘8ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦
    const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
    return passwordRegex.test(password);
  }
  
  private containsSqlInjection(input: string): boolean {
    const sqlInjectionPatterns = [
      /(\b(SELECT|INSERT|UPDATE|DELETE|DROP|CREATE|ALTER|EXEC|UNION|SCRIPT)\b)/i,
      /(\b(OR|AND)\s+\d+\s*=\s*\d+)/i,
      /(\b(OR|AND)\s+['"]\s*=\s*['"])/i,
      /(\b(OR|AND)\s+['"]\s*LIKE\s*['"])/i
    ];
    
    return sqlInjectionPatterns.some(pattern => pattern.test(input));
  }
}
```

#### 5.1.2 å‚æ•°éªŒè¯

**âœ… å¥½çš„åšæ³•**:

```typescript
/**
 * ç”¨æˆ·æ§åˆ¶å™¨ï¼ˆå¸¦å‚æ•°éªŒè¯ï¼‰
 * 
 * @description ç”¨æˆ·æ§åˆ¶å™¨ï¼ŒåŒ…å«ä¸¥æ ¼çš„å‚æ•°éªŒè¯
 * ä½¿ç”¨è£…é¥°å™¨è¿›è¡Œå‚æ•°éªŒè¯
 */
@Controller('users')
export class UserController {
  constructor(
    private readonly userService: UserService,
    private readonly inputValidator: UserInputValidator
  ) {}
  
  /**
   * åˆ›å»ºç”¨æˆ·
   * 
   * @param request åˆ›å»ºç”¨æˆ·è¯·æ±‚
   * @returns åˆ›å»ºç”¨æˆ·å“åº”
   */
  @Post()
  @UseGuards(AuthenticationGuard)
  @UsePipes(new ValidationPipe({
    transform: true,
    whitelist: true,
    forbidNonWhitelisted: true,
    validationError: {
      target: false,
      value: false
    }
  }))
  public async createUser(@Body() request: CreateUserRequest): Promise<CreateUserResponse> {
    // 1. å‚æ•°éªŒè¯
    const validationResult = this.inputValidator.validateUserRegistration(request);
    if (!validationResult.isValid) {
      throw new ValidationException('è¯·æ±‚å‚æ•°éªŒè¯å¤±è´¥', validationResult.errors);
    }
    
    // 2. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    return await this.userService.createUser(request);
  }
  
  /**
   * è·å–ç”¨æˆ·
   * 
   * @param id ç”¨æˆ·ID
   * @returns ç”¨æˆ·ä¿¡æ¯
   */
  @Get(':id')
  @UseGuards(AuthenticationGuard, AuthorizationGuard)
  public async getUser(@Param('id', ParseUUIDPipe) id: string): Promise<GetUserResponse> {
    // UUIDæ ¼å¼éªŒè¯
    return await this.userService.getUser(id);
  }
}
```

### 5.2 æƒé™æ§åˆ¶

#### 5.2.1 è®¿é—®æ§åˆ¶

**âœ… å¥½çš„åšæ³•**:

```typescript
/**
 * ç”¨æˆ·æƒé™å®ˆå«
 * 
 * @description ç”¨æˆ·æƒé™éªŒè¯å®ˆå«
 * å®ç°ç»†ç²’åº¦çš„æƒé™æ§åˆ¶
 */
@Injectable()
export class UserPermissionGuard implements CanActivate {
  constructor(
    private readonly userService: UserService,
    private readonly permissionService: PermissionService
  ) {}
  
  public async canActivate(context: ExecutionContext): Promise<boolean> {
    const request = context.switchToHttp().getRequest();
    const user = request.user;
    const resource = request.params.id;
    
    // 1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ¿€æ´»
    if (!user.isActive()) {
      throw new UnauthorizedException('ç”¨æˆ·æœªæ¿€æ´»');
    }
    
    // 2. æ£€æŸ¥èµ„æºè®¿é—®æƒé™
    const hasPermission = await this.permissionService.hasPermission(
      user.id,
      'USER_READ',
      resource
    );
    
    if (!hasPermission) {
      throw new ForbiddenException('æ²¡æœ‰è®¿é—®æƒé™');
    }
    
    return true;
  }
}

/**
 * ç”¨æˆ·æœåŠ¡ï¼ˆå¸¦æƒé™æ§åˆ¶ï¼‰
 * 
 * @description ç”¨æˆ·æœåŠ¡ï¼ŒåŒ…å«æƒé™æ§åˆ¶é€»è¾‘
 */
@Injectable()
export class UserService {
  constructor(
    private readonly userRepository: IUserRepository,
    private readonly permissionService: PermissionService
  ) {}
  
  /**
   * è·å–ç”¨æˆ·ä¿¡æ¯
   * 
   * @param userId ç”¨æˆ·ID
   * @param requesterId è¯·æ±‚è€…ID
   * @returns ç”¨æˆ·ä¿¡æ¯
   */
  public async getUser(userId: string, requesterId: string): Promise<User> {
    // 1. æƒé™æ£€æŸ¥
    await this.checkUserReadPermission(requesterId, userId);
    
    // 2. è·å–ç”¨æˆ·ä¿¡æ¯
    const user = await this.userRepository.findById(new UserId(userId));
    if (!user) {
      throw new UserNotFoundException(userId);
    }
    
    // 3. æ•°æ®è„±æ•
    return this.sanitizeUserData(user, requesterId);
  }
  
  private async checkUserReadPermission(requesterId: string, targetUserId: string): Promise<void> {
    const hasPermission = await this.permissionService.hasPermission(
      requesterId,
      'USER_READ',
      targetUserId
    );
    
    if (!hasPermission) {
      throw new ForbiddenException('æ²¡æœ‰è¯»å–ç”¨æˆ·ä¿¡æ¯çš„æƒé™');
    }
  }
  
  private sanitizeUserData(user: User, requesterId: string): User {
    // å¦‚æœä¸æ˜¯ç”¨æˆ·æœ¬äººï¼Œè„±æ•æ•æ„Ÿä¿¡æ¯
    if (user.id.value !== requesterId) {
      return user.sanitize();
    }
    
    return user;
  }
}
```

### 5.3 æ•°æ®éš”ç¦»

#### 5.3.1 å¤šç§Ÿæˆ·éš”ç¦»

**âœ… å¥½çš„åšæ³•**:

```typescript
/**
 * å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»æœåŠ¡
 * 
 * @description ç¡®ä¿å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»
 * é˜²æ­¢ç§Ÿæˆ·é—´æ•°æ®æ³„éœ²
 */
@Injectable()
export class MultiTenantIsolationService {
  constructor(
    private readonly isolationContext: IsolationContext
  ) {}
  
  /**
   * åº”ç”¨ç§Ÿæˆ·éš”ç¦»æ¡ä»¶
   * 
   * @param query æŸ¥è¯¢æ¡ä»¶
   * @returns å¸¦éš”ç¦»æ¡ä»¶çš„æŸ¥è¯¢
   */
  public applyTenantIsolation<T>(query: any): any {
    return {
      ...query,
      tenantId: this.isolationContext.tenantId.value,
      organizationId: this.isolationContext.organizationId?.value,
      departmentId: this.isolationContext.departmentId?.value
    };
  }
  
  /**
   * éªŒè¯æ•°æ®è®¿é—®æƒé™
   * 
   * @param resource èµ„æº
   * @throws DataAccessDeniedException æ•°æ®è®¿é—®è¢«æ‹’ç»æ—¶æŠ›å‡º
   */
  public validateDataAccess(resource: any): void {
    // æ£€æŸ¥ç§Ÿæˆ·éš”ç¦»
    if (resource.tenantId !== this.isolationContext.tenantId.value) {
      throw new DataAccessDeniedException('è·¨ç§Ÿæˆ·æ•°æ®è®¿é—®è¢«æ‹’ç»');
    }
    
    // æ£€æŸ¥ç»„ç»‡éš”ç¦»
    if (resource.organizationId && 
        resource.organizationId !== this.isolationContext.organizationId?.value) {
      throw new DataAccessDeniedException('è·¨ç»„ç»‡æ•°æ®è®¿é—®è¢«æ‹’ç»');
    }
    
    // æ£€æŸ¥éƒ¨é—¨éš”ç¦»
    if (resource.departmentId && 
        resource.departmentId !== this.isolationContext.departmentId?.value) {
      throw new DataAccessDeniedException('è·¨éƒ¨é—¨æ•°æ®è®¿é—®è¢«æ‹’ç»');
    }
  }
}
```

---

## 6. æµ‹è¯•æœ€ä½³å®è·µ

### 6.1 æµ‹è¯•ç­–ç•¥

#### 6.1.1 æµ‹è¯•é‡‘å­—å¡”

**âœ… å¥½çš„åšæ³•**:

```typescript
// å•å…ƒæµ‹è¯• - æµ‹è¯•å•ä¸ªç»„ä»¶
describe('User Entity', () => {
  it('åº”è¯¥æ­£ç¡®åˆ›å»ºç”¨æˆ·', () => {
    const user = new User(
      new UserId('user-123'),
      new Email('user@example.com'),
      new Username('john_doe')
    );
    
    expect(user.id.value).toBe('user-123');
    expect(user.email.value).toBe('user@example.com');
    expect(user.username.value).toBe('john_doe');
  });
});

// é›†æˆæµ‹è¯• - æµ‹è¯•ç»„ä»¶åä½œ
describe('User Service Integration', () => {
  it('åº”è¯¥æˆåŠŸåˆ›å»ºç”¨æˆ·å¹¶ä¿å­˜åˆ°æ•°æ®åº“', async () => {
    const userService = new UserService(userRepository, eventBus);
    const request = new CreateUserRequest('user@example.com', 'john_doe');
    
    const response = await userService.createUser(request);
    
    expect(response.userId).toBeDefined();
    expect(await userRepository.findById(response.userId)).toBeDefined();
  });
});

// ç«¯åˆ°ç«¯æµ‹è¯• - æµ‹è¯•å®Œæ•´æµç¨‹
describe('User Management E2E', () => {
  it('åº”è¯¥å®Œæˆç”¨æˆ·åˆ›å»ºåˆ°åˆ é™¤çš„å®Œæ•´æµç¨‹', async () => {
    // 1. åˆ›å»ºç”¨æˆ·
    const createResponse = await request(app.getHttpServer())
      .post('/api/users')
      .send({ email: 'user@example.com', username: 'john_doe' })
      .expect(201);
    
    // 2. è·å–ç”¨æˆ·
    await request(app.getHttpServer())
      .get(`/api/users/${createResponse.body.userId}`)
      .expect(200);
    
    // 3. åˆ é™¤ç”¨æˆ·
    await request(app.getHttpServer())
      .delete(`/api/users/${createResponse.body.userId}`)
      .expect(200);
  });
});
```

#### 6.1.2 æµ‹è¯•æ•°æ®ç®¡ç†

**âœ… å¥½çš„åšæ³•**:

```typescript
/**
 * æµ‹è¯•æ•°æ®å·¥å‚
 * 
 * @description åˆ›å»ºæµ‹è¯•æ•°æ®çš„å·¥å‚ç±»
 * æä¾›ä¸€è‡´çš„æµ‹è¯•æ•°æ®
 */
export class UserTestDataFactory {
  /**
   * åˆ›å»ºæµ‹è¯•ç”¨æˆ·
   * 
   * @param overrides è¦†ç›–å±æ€§
   * @returns æµ‹è¯•ç”¨æˆ·
   */
  public static createUser(overrides: Partial<UserData> = {}): User {
    const defaultData: UserData = {
      id: 'user-123',
      email: 'test@example.com',
      username: 'testuser',
      status: UserStatus.ACTIVE,
      createdAt: new Date(),
      updatedAt: new Date()
    };
    
    const userData = { ...defaultData, ...overrides };
    
    return new User(
      new UserId(userData.id),
      new Email(userData.email),
      new Username(userData.username)
    );
  }
  
  /**
   * åˆ›å»ºæµ‹è¯•ç”¨æˆ·åˆ—è¡¨
   * 
   * @param count æ•°é‡
   * @returns æµ‹è¯•ç”¨æˆ·åˆ—è¡¨
   */
  public static createUsers(count: number): User[] {
    return Array.from({ length: count }, (_, index) => 
      this.createUser({
        id: `user-${index + 1}`,
        email: `user${index + 1}@example.com`,
        username: `user${index + 1}`
      })
    );
  }
}

// ä½¿ç”¨æµ‹è¯•æ•°æ®å·¥å‚
describe('User Service', () => {
  it('åº”è¯¥å¤„ç†å¤šä¸ªç”¨æˆ·', async () => {
    const users = UserTestDataFactory.createUsers(5);
    
    for (const user of users) {
      await userService.createUser(user);
    }
    
    const allUsers = await userService.getAllUsers();
    expect(allUsers).toHaveLength(5);
  });
});
```

### 6.2 æµ‹è¯•è´¨é‡

#### 6.2.1 æµ‹è¯•è¦†ç›–ç‡

**âœ… å¥½çš„åšæ³•**:

```typescript
// jest.config.js
module.exports = {
  collectCoverage: true,
  coverageDirectory: 'coverage',
  coverageReporters: ['text', 'lcov', 'html'],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80
    },
    // é¢†åŸŸå±‚è¦æ±‚æ›´é«˜çš„è¦†ç›–ç‡
    './src/domain/': {
      branches: 90,
      functions: 90,
      lines: 90,
      statements: 90
    }
  }
};
```

#### 6.2.2 æµ‹è¯•ç»´æŠ¤

**âœ… å¥½çš„åšæ³•**:

```typescript
/**
 * æµ‹è¯•åŸºç±»
 * 
 * @description æä¾›æµ‹è¯•çš„é€šç”¨åŠŸèƒ½
 * å‡å°‘æµ‹è¯•ä»£ç é‡å¤
 */
export abstract class TestBase {
  protected userRepository: jest.Mocked<IUserRepository>;
  protected eventBus: jest.Mocked<IEventBus>;
  protected emailService: jest.Mocked<IEmailService>;
  
  protected setupMocks(): void {
    this.userRepository = {
      save: jest.fn(),
      findById: jest.fn(),
      findByEmail: jest.fn(),
      delete: jest.fn()
    };
    
    this.eventBus = {
      publish: jest.fn()
    };
    
    this.emailService = {
      sendEmail: jest.fn()
    };
  }
  
  protected resetMocks(): void {
    jest.clearAllMocks();
  }
}

// ä½¿ç”¨æµ‹è¯•åŸºç±»
describe('User Service', () => {
  class UserServiceTest extends TestBase {
    private userService: UserService;
    
    beforeEach(() => {
      this.setupMocks();
      this.userService = new UserService(
        this.userRepository,
        this.eventBus,
        this.emailService
      );
    });
    
    afterEach(() => {
      this.resetMocks();
    });
    
    it('åº”è¯¥åˆ›å»ºç”¨æˆ·', async () => {
      // æµ‹è¯•é€»è¾‘
    });
  }
});
```

---

## ğŸ“ æ€»ç»“

æœ€ä½³å®è·µæ¦‚è¿°ä¸ºHL8 SAASå¹³å°çš„å¼€å‘æä¾›äº†å…¨é¢çš„æŒ‡å¯¼ã€‚é€šè¿‡éµå¾ªè¿™äº›æœ€ä½³å®è·µï¼Œå¯ä»¥ç¡®ä¿ï¼š

- **ä»£ç è´¨é‡**: é«˜è´¨é‡ã€å¯ç»´æŠ¤çš„ä»£ç 
- **ç³»ç»Ÿæ€§èƒ½**: é«˜æ€§èƒ½ã€å¯æ‰©å±•çš„ç³»ç»Ÿ
- **å®‰å…¨æ€§**: å®‰å…¨å¯é çš„æ•°æ®å¤„ç†
- **å¯æµ‹è¯•æ€§**: æ˜“äºæµ‹è¯•å’ŒéªŒè¯
- **å¯ç»´æŠ¤æ€§**: æ˜“äºç†è§£å’Œä¿®æ”¹

è¿™äº›æœ€ä½³å®è·µæ¶µç›–äº†æ¶æ„è®¾è®¡ã€ä»£ç è´¨é‡ã€æ€§èƒ½ä¼˜åŒ–ã€å®‰å…¨æ€§å’Œæµ‹è¯•ç­‰å„ä¸ªæ–¹é¢ï¼Œä¸ºå¼€å‘å›¢é˜Ÿæä¾›äº†æ¸…æ™°çš„å¼€å‘æŒ‡å¯¼ã€‚
