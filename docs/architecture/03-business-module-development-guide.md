# ä¸šåŠ¡æ¨¡å—å¼€å‘æŒ‡å—

> **ç‰ˆæœ¬**: 1.0.0 | **åˆ›å»ºæ—¥æœŸ**: 2025-01-27 | **æ¨¡å—**: æ¶æ„è®¾è®¡æ–‡æ¡£

---

## ğŸ“‹ ç›®å½•

- [1. ä¸šåŠ¡æ¨¡å—å¼€å‘æ¦‚è¿°](#1-ä¸šåŠ¡æ¨¡å—å¼€å‘æ¦‚è¿°)
- [2. å¼€å‘ç¯å¢ƒå‡†å¤‡](#2-å¼€å‘ç¯å¢ƒå‡†å¤‡)
- [3. ä¸šåŠ¡æ¨¡å—ç»“æ„](#3-ä¸šåŠ¡æ¨¡å—ç»“æ„)
- [4. å¼€å‘æµç¨‹](#4-å¼€å‘æµç¨‹)
- [5. ä»£ç å®ç°æŒ‡å—](#5-ä»£ç å®ç°æŒ‡å—)
- [6. æµ‹è¯•ç­–ç•¥](#6-æµ‹è¯•ç­–ç•¥)
- [7. éƒ¨ç½²å’Œé›†æˆ](#7-éƒ¨ç½²å’Œé›†æˆ)
- [8. æœ€ä½³å®è·µ](#8-æœ€ä½³å®è·µ)

---

## 1. ä¸šåŠ¡æ¨¡å—å¼€å‘æ¦‚è¿°

### 1.1 ä¸šåŠ¡æ¨¡å—å®šä¹‰

ä¸šåŠ¡æ¨¡å—æ˜¯HL8 SAASå¹³å°ä¸­çš„ç‹¬ç«‹åŠŸèƒ½å•å…ƒï¼Œæ¯ä¸ªæ¨¡å—éƒ½éµå¾ªæ··åˆæ¶æ„æ¨¡å¼ï¼ŒåŒ…å«å®Œæ•´çš„å››å±‚æ¶æ„ï¼šé¢†åŸŸå±‚ã€åº”ç”¨å±‚ã€åŸºç¡€è®¾æ–½å±‚å’Œæ¥å£å±‚ã€‚

### 1.2 ä¸šåŠ¡æ¨¡å—ç‰¹ç‚¹

- **ç‹¬ç«‹æ€§**: æ¯ä¸ªä¸šåŠ¡æ¨¡å—éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œå¯ä»¥å•ç‹¬å¼€å‘ã€æµ‹è¯•å’Œéƒ¨ç½²
- **å¯å¤ç”¨æ€§**: ä¸šåŠ¡æ¨¡å—å¯ä»¥åœ¨ä¸åŒçš„ç§Ÿæˆ·å’Œç»„ç»‡ä¸­å¤ç”¨
- **å¯æ‰©å±•æ€§**: æ”¯æŒåŠŸèƒ½çš„æ‰©å±•å’Œå®šåˆ¶
- **å¤šç§Ÿæˆ·æ”¯æŒ**: å†…ç½®å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»å’Œæƒé™æ§åˆ¶
- **äº‹ä»¶é©±åŠ¨**: æ”¯æŒäº‹ä»¶é©±åŠ¨çš„ä¸šåŠ¡æµç¨‹

### 1.3 ä¸šåŠ¡æ¨¡å—ç±»å‹

#### 1.3.1 æ ¸å¿ƒä¸šåŠ¡æ¨¡å—

- **ç”¨æˆ·ç®¡ç†æ¨¡å—**: ç”¨æˆ·æ³¨å†Œã€è®¤è¯ã€æƒé™ç®¡ç†
- **ç»„ç»‡ç®¡ç†æ¨¡å—**: ç»„ç»‡åˆ›å»ºã€ç®¡ç†ã€éƒ¨é—¨ç»“æ„
- **ç§Ÿæˆ·ç®¡ç†æ¨¡å—**: ç§Ÿæˆ·åˆ›å»ºã€é…ç½®ã€éš”ç¦»ç®¡ç†

#### 1.3.2 ä¸šåŠ¡åŠŸèƒ½æ¨¡å—

- **è®¢å•ç®¡ç†æ¨¡å—**: è®¢å•åˆ›å»ºã€å¤„ç†ã€çŠ¶æ€ç®¡ç†
- **äº§å“ç®¡ç†æ¨¡å—**: äº§å“ä¿¡æ¯ã€åº“å­˜ã€ä»·æ ¼ç®¡ç†
- **æ”¯ä»˜æ¨¡å—**: æ”¯ä»˜å¤„ç†ã€è´¦å•ã€è´¢åŠ¡è®°å½•

#### 1.3.3 æ‰©å±•åŠŸèƒ½æ¨¡å—

- **æŠ¥è¡¨æ¨¡å—**: æ•°æ®ç»Ÿè®¡ã€æŠ¥è¡¨ç”Ÿæˆã€åˆ†æ
- **é€šçŸ¥æ¨¡å—**: æ¶ˆæ¯æ¨é€ã€é‚®ä»¶é€šçŸ¥ã€çŸ­ä¿¡é€šçŸ¥
- **é›†æˆæ¨¡å—**: ç¬¬ä¸‰æ–¹ç³»ç»Ÿé›†æˆã€APIæ¥å£

---

## 2. å¼€å‘ç¯å¢ƒå‡†å¤‡

### 2.1 ç¯å¢ƒè¦æ±‚

- **Node.js**: >= 20.0.0
- **pnpm**: >= 8.0.0
- **TypeScript**: >= 5.0.0
- **NestJS**: >= 10.0.0

### 2.2 é¡¹ç›®ç»“æ„

```
hl8-ai-saas-platform/
â”œâ”€â”€ apps/                          # åº”ç”¨ç¨‹åº
â”‚   â””â”€â”€ fastify-api/              # Fastify APIåº”ç”¨
â”œâ”€â”€ libs/                         # æ ¸å¿ƒåº“
â”‚   â”œâ”€â”€ domain-kernel/            # é¢†åŸŸå±‚æ ¸å¿ƒ
â”‚   â”œâ”€â”€ application-kernel/        # åº”ç”¨å±‚æ ¸å¿ƒ
â”‚   â”œâ”€â”€ infrastructure-kernel/    # åŸºç¡€è®¾æ–½å±‚æ ¸å¿ƒ
â”‚   â”œâ”€â”€ interface-kernel/         # æ¥å£å±‚æ ¸å¿ƒ
â”‚   â”œâ”€â”€ config/                   # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ database/                 # æ•°æ®åº“ç®¡ç†
â”‚   â”œâ”€â”€ caching/                  # ç¼“å­˜ç®¡ç†
â”‚   â”œâ”€â”€ messaging/                # æ¶ˆæ¯ç®¡ç†
â”‚   â””â”€â”€ exceptions/                # å¼‚å¸¸å¤„ç†
â”œâ”€â”€ packages/                     # å…±äº«åŒ…
â”‚   â”œâ”€â”€ eslint-config/            # ESLinté…ç½®
â”‚   â””â”€â”€ typescript-config/        # TypeScripté…ç½®
â””â”€â”€ docs/                        # æ–‡æ¡£
    â””â”€â”€ architecture/             # æ¶æ„æ–‡æ¡£
```

### 2.3 å¼€å‘å·¥å…·é…ç½®

#### 2.3.1 IDEé…ç½®

æ¨èä½¿ç”¨VS Codeï¼Œå®‰è£…ä»¥ä¸‹æ‰©å±•ï¼š

- TypeScript Importer
- ESLint
- Prettier
- GitLens
- Thunder Client (APIæµ‹è¯•)

#### 2.3.2 ä»£ç è§„èŒƒ

é¡¹ç›®ä½¿ç”¨ç»Ÿä¸€çš„ä»£ç è§„èŒƒï¼š

- **ESLint**: ä»£ç è´¨é‡æ£€æŸ¥
- **Prettier**: ä»£ç æ ¼å¼åŒ–
- **TypeScript**: ç±»å‹æ£€æŸ¥
- **Jest**: å•å…ƒæµ‹è¯•

### 2.4 ç¯å¢ƒå˜é‡é…ç½®

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
# æ•°æ®åº“é…ç½®
DB_HOST=localhost
DB_PORT=5432
DB_DATABASE=hl8_platform
DB_USERNAME=hl8_user
DB_PASSWORD=hl8_password

# Redisé…ç½®
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# åº”ç”¨é…ç½®
NODE_ENV=development
PORT=3000
HOST=0.0.0.0

# æ—¥å¿—é…ç½®
LOGGING_LEVEL=info
LOGGING_PRETTY_PRINT=true

# ç¼“å­˜é…ç½®
CACHE_TTL=3600
CACHE_MAX_ITEMS=1000
```

---

## 3. ä¸šåŠ¡æ¨¡å—ç»“æ„

### 3.1 æ ‡å‡†æ¨¡å—ç»“æ„

```
business-module/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ domain/                   # é¢†åŸŸå±‚
â”‚   â”‚   â”œâ”€â”€ entities/            # å®ä½“
â”‚   â”‚   â”œâ”€â”€ aggregates/           # èšåˆæ ¹
â”‚   â”‚   â”œâ”€â”€ value-objects/       # å€¼å¯¹è±¡
â”‚   â”‚   â”œâ”€â”€ domain-services/      # é¢†åŸŸæœåŠ¡
â”‚   â”‚   â”œâ”€â”€ domain-events/       # é¢†åŸŸäº‹ä»¶
â”‚   â”‚   â”œâ”€â”€ business-rules/      # ä¸šåŠ¡è§„åˆ™
â”‚   â”‚   â””â”€â”€ interfaces/           # é¢†åŸŸæ¥å£
â”‚   â”œâ”€â”€ application/             # åº”ç”¨å±‚
â”‚   â”‚   â”œâ”€â”€ use-cases/           # ç”¨ä¾‹
â”‚   â”‚   â”œâ”€â”€ commands/            # å‘½ä»¤
â”‚   â”‚   â”œâ”€â”€ queries/             # æŸ¥è¯¢
â”‚   â”‚   â”œâ”€â”€ command-handlers/    # å‘½ä»¤å¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ query-handlers/      # æŸ¥è¯¢å¤„ç†å™¨
â”‚   â”‚   â””â”€â”€ services/            # åº”ç”¨æœåŠ¡
â”‚   â”œâ”€â”€ infrastructure/          # åŸºç¡€è®¾æ–½å±‚
â”‚   â”‚   â”œâ”€â”€ repositories/        # ä»“å‚¨å®ç°
â”‚   â”‚   â”œâ”€â”€ external-services/   # å¤–éƒ¨æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ message-queue/       # æ¶ˆæ¯é˜Ÿåˆ—
â”‚   â”‚   â””â”€â”€ cache/              # ç¼“å­˜å®ç°
â”‚   â”œâ”€â”€ interface/               # æ¥å£å±‚
â”‚   â”‚   â”œâ”€â”€ controllers/         # æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ resolvers/           # GraphQLè§£æå™¨
â”‚   â”‚   â”œâ”€â”€ middleware/           # ä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ guards/              # å®ˆå«
â”‚   â”‚   â”œâ”€â”€ decorators/          # è£…é¥°å™¨
â”‚   â”‚   â””â”€â”€ dto/                 # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â””â”€â”€ module/                  # æ¨¡å—å®šä¹‰
â”‚       â”œâ”€â”€ domain.module.ts     # é¢†åŸŸæ¨¡å—
â”‚       â”œâ”€â”€ application.module.ts # åº”ç”¨æ¨¡å—
â”‚       â”œâ”€â”€ infrastructure.module.ts # åŸºç¡€è®¾æ–½æ¨¡å—
â”‚       â”œâ”€â”€ interface.module.ts  # æ¥å£æ¨¡å—
â”‚       â””â”€â”€ business.module.ts   # ä¸šåŠ¡æ¨¡å—
â”œâ”€â”€ test/                        # æµ‹è¯•
â”‚   â”œâ”€â”€ unit/                    # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ integration/              # é›†æˆæµ‹è¯•
â”‚   â””â”€â”€ e2e/                     # ç«¯åˆ°ç«¯æµ‹è¯•
â”œâ”€â”€ docs/                        # æ–‡æ¡£
â”‚   â”œâ”€â”€ api/                     # APIæ–‡æ¡£
â”‚   â”œâ”€â”€ design/                  # è®¾è®¡æ–‡æ¡£
â”‚   â””â”€â”€ user-guide/              # ç”¨æˆ·æŒ‡å—
â”œâ”€â”€ package.json                 # åŒ…é…ç½®
â”œâ”€â”€ tsconfig.json               # TypeScripté…ç½®
â”œâ”€â”€ jest.config.js              # Jesté…ç½®
â””â”€â”€ README.md                   # æ¨¡å—è¯´æ˜
```

### 3.2 æ¨¡å—ä¾èµ–å…³ç³»

```
Business Module
â”œâ”€â”€ @hl8/domain-kernel          # é¢†åŸŸå±‚æ ¸å¿ƒ
â”œâ”€â”€ @hl8/application-kernel     # åº”ç”¨å±‚æ ¸å¿ƒ
â”œâ”€â”€ @hl8/infrastructure-kernel # åŸºç¡€è®¾æ–½å±‚æ ¸å¿ƒ
â”œâ”€â”€ @hl8/interface-kernel        # æ¥å£å±‚æ ¸å¿ƒ
â”œâ”€â”€ @hl8/config                # é…ç½®ç®¡ç†
â”œâ”€â”€ @hl8/database              # æ•°æ®åº“ç®¡ç†
â”œâ”€â”€ @hl8/caching               # ç¼“å­˜ç®¡ç†
â”œâ”€â”€ @hl8/messaging             # æ¶ˆæ¯ç®¡ç†
â””â”€â”€ @hl8/exceptions            # å¼‚å¸¸å¤„ç†
```

### 3.3 ä¼˜å…ˆä½¿ç”¨ kernel ç»„ä»¶

> **âš ï¸ é‡è¦**: ä¸šåŠ¡æ¨¡å—çš„å¼€å‘**å¿…é¡»åŸºäº**ä»¥ä¸‹ kernel å’ŒåŸºç¡€åº“æä¾›çš„é€šç”¨ç»„ä»¶ï¼š
> - **@hl8/domain-kernel** - é¢†åŸŸå±‚æ ¸å¿ƒ
> - **@hl8/application-kernel** - åº”ç”¨å±‚æ ¸å¿ƒ
> - **@hl8/infrastructure-kernel** - åŸºç¡€è®¾æ–½å±‚æ ¸å¿ƒ
> - **@hl8/interface-kernel** - æ¥å£å±‚æ ¸å¿ƒ
> - **@hl8/exceptions** - å¼‚å¸¸å¤„ç†
> - **@hl8/caching** - ç¼“å­˜ç®¡ç†
> - **@hl8/config** - é…ç½®ç®¡ç†
> - **@hl8/nestjs-fastify** - Fastify é›†æˆå’Œ logging
> 
> å› æ­¤ï¼Œå¿…é¡»ä¼˜å…ˆä½¿ç”¨è¿™äº› kernel å’ŒåŸºç¡€åº“æä¾›çš„ç»„ä»¶ï¼Œè€Œä¸æ˜¯é‡æ–°å®šä¹‰ã€‚

#### 3.3.1 ä¸ºä»€ä¹ˆå¿…é¡»åŸºäº kernel å±‚ï¼Ÿ

ä¸šåŠ¡æ¨¡å—å¼€å‘å¿…é¡»åŸºäº kernel å±‚ï¼Œä½¿ç”¨å…¶æä¾›çš„ç»„ä»¶æœ‰ä»¥ä¸‹é‡è¦ä¼˜åŠ¿ï¼š

- **ç»Ÿä¸€æ¶æ„**: æ‰€æœ‰ä¸šåŠ¡æ¨¡å—åŸºäºç›¸åŒçš„æ¶æ„ï¼Œç¡®ä¿ä¸€è‡´æ€§å’Œå¯ç»´æŠ¤æ€§
- **ä¿è¯ä¸€è‡´æ€§**: ä½¿ç”¨ç›¸åŒçš„åŸºç±»å’Œæ¥å£ï¼Œç¡®ä¿è¡Œä¸ºä¸€è‡´
- **å‡å°‘é‡å¤**: é¿å…åœ¨æ¯ä¸ªæ¨¡å—ä¸­é‡å¤å®šä¹‰ç›¸åŒçš„ç±»
- **ç®€åŒ–ç»´æŠ¤**: åªéœ€åœ¨ä¸€ä¸ªåœ°æ–¹ç»´æŠ¤å’Œæ›´æ–°
- **ç±»å‹å®‰å…¨**: ç»Ÿä¸€çš„ç±»å‹å®šä¹‰ç¡®ä¿ç±»å‹å®‰å…¨
- **å¤šç§Ÿæˆ·æ”¯æŒ**: æ­£ç¡®çš„æ•°æ®éš”ç¦»æœºåˆ¶
- **æ¶æ„æ¸…æ™°**: æ˜ç¡®çš„åˆ†å±‚æ¶æ„ï¼Œä¾¿äºç†è§£å’Œæ‰©å±•

#### 3.3.2 Domain-Kernel ç»„ä»¶ï¼ˆé¢†åŸŸå±‚ï¼‰

**3.3.2.1 å¿…é¡»ä½¿ç”¨çš„åŸºç±»**

æ‰€æœ‰é¢†åŸŸå®ä½“ã€èšåˆæ ¹å’Œå€¼å¯¹è±¡éƒ½åº”è¯¥ç»§æ‰¿ domain-kernel æä¾›çš„åŸºç±»ï¼š

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ domain-kernel çš„åŸºç±»
import { BaseEntity, AggregateRoot, BaseValueObject } from "@hl8/domain-kernel";

export class User extends BaseEntity {
  // ...
}

export class OrderAggregate extends AggregateRoot {
  // ...
}

export class Email extends BaseValueObject {
  // ...
}
```

```typescript
// âŒ é”™è¯¯ï¼šè‡ªå·±å®šä¹‰åŸºç±»
export abstract class BaseEntity {
  // ... é‡å¤å®šä¹‰
}
```

**3.3.2.2 å¿…é¡»ä½¿ç”¨çš„ ID å€¼å¯¹è±¡**

æ‰€æœ‰å®ä½“ ID éƒ½åº”è¯¥ä½¿ç”¨ domain-kernel æä¾›çš„ ID å€¼å¯¹è±¡ï¼š

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ domain-kernel çš„ ID å€¼å¯¹è±¡
import { 
  TenantId, 
  OrganizationId, 
  DepartmentId, 
  UserId,
  GenericEntityId 
} from "@hl8/domain-kernel";

export class User extends BaseEntity {
  constructor(
    id: UserId,
    // ...
  ) {
    super(id);
  }
}
```

```typescript
// âŒ é”™è¯¯ï¼šè‡ªå·±å®šä¹‰ ID å€¼å¯¹è±¡
export class UserId extends BaseValueObject {
  // ... é‡å¤å®šä¹‰
}
```

**3.3.2.3 å¿…é¡»ä½¿ç”¨çš„æ•°æ®éš”ç¦»æœºåˆ¶**

æ‰€æœ‰æ¶‰åŠå¤šç§Ÿæˆ·æ•°æ®è®¿é—®çš„æ“ä½œéƒ½å¿…é¡»ä½¿ç”¨ `IsolationContext`ï¼š

#### 3.3.3 Application-Kernel ç»„ä»¶ï¼ˆåº”ç”¨å±‚ï¼‰

**å¿…é¡»ä¼˜å…ˆä½¿ç”¨** `@hl8/application-kernel` æä¾›çš„ä»¥ä¸‹ç»„ä»¶ï¼š

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ application-kernel çš„åŸºç±»
import { 
  BaseCommand, 
  BaseQuery, 
  BaseUseCase,
  CommandHandler,
  QueryHandler
} from "@hl8/application-kernel";

export class CreateUserCommand extends BaseCommand { ... }
export class GetUserQuery extends BaseQuery { ... }
export class CreateUserUseCase extends BaseUseCase { ... }
export class CreateUserHandler implements CommandHandler { ... }
```

#### 3.3.4 Infrastructure-Kernel ç»„ä»¶ï¼ˆåŸºç¡€è®¾æ–½å±‚ï¼‰

**å¿…é¡»ä¼˜å…ˆä½¿ç”¨** `@hl8/infrastructure-kernel` æä¾›çš„ä»¥ä¸‹ç»„ä»¶ï¼š

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ infrastructure-kernel çš„æ¥å£
import { 
  IDatabaseAdapter,
  ICacheService,
  IMessageBroker
} from "@hl8/infrastructure-kernel";

export class UserRepository implements IDatabaseAdapter { ... }
export class RedisCacheService implements ICacheService { ... }
export class RabbitMQBroker implements IMessageBroker { ... }
```

#### 3.3.5 Interface-Kernel ç»„ä»¶ï¼ˆæ¥å£å±‚ï¼‰

**å¿…é¡»ä¼˜å…ˆä½¿ç”¨** `@hl8/interface-kernel` æä¾›çš„ä»¥ä¸‹ç»„ä»¶ï¼š

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ interface-kernel çš„åŸºç±»å’Œå®ˆå«
import { 
  RestController,
  AuthenticationGuard,
  AuthorizationGuard
} from "@hl8/interface-kernel";

export class UserController extends RestController {
  @Get()
  @UseGuards(AuthenticationGuard, AuthorizationGuard)
  public async getUsers() { ... }
}
```

#### 3.3.6 Exceptions ç»„ä»¶ï¼ˆå¼‚å¸¸å¤„ç†ï¼‰

**å¿…é¡»ä¼˜å…ˆä½¿ç”¨** `@hl8/exceptions` æä¾›çš„å¼‚å¸¸ç±»ï¼š

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ exceptions åº“çš„å¼‚å¸¸ç±»
import { 
  DomainException,
  BusinessException,
  ValidationException,
  NotFoundException
} from "@hl8/exceptions";

export class UserService {
  public async getUser(id: string): Promise<User> {
    const user = await this.userRepository.findById(id);
    if (!user) {
      throw new NotFoundException(`User with ID ${id} not found`);
    }
    return user;
  }
}
```

```typescript
// âŒ é”™è¯¯ï¼šè‡ªå·±å®šä¹‰å¼‚å¸¸ç±»
export class NotFoundException extends Error {
  // ... é‡å¤å®šä¹‰
}
```

#### 3.3.7 Caching ç»„ä»¶ï¼ˆç¼“å­˜ç®¡ç†ï¼‰

**å¿…é¡»ä¼˜å…ˆä½¿ç”¨** `@hl8/caching` æä¾›çš„ç¼“å­˜æœåŠ¡ï¼š

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ caching åº“çš„ç¼“å­˜æœåŠ¡
import { ICacheService } from "@hl8/caching";

@Injectable()
export class UserService {
  constructor(private readonly cacheService: ICacheService) {}
  
  public async getUser(id: string): Promise<User> {
    const cacheKey = `user:${id}`;
    let user = await this.cacheService.get<User>(cacheKey);
    
    if (!user) {
      user = await this.userRepository.findById(id);
      await this.cacheService.set(cacheKey, user, 3600);
    }
    
    return user;
  }
}
```

#### 3.3.8 Config ç»„ä»¶ï¼ˆé…ç½®ç®¡ç†ï¼‰

**å¿…é¡»ä¼˜å…ˆä½¿ç”¨** `@hl8/config` æä¾›çš„é…ç½®ç®¡ç†ï¼š

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ config åº“çš„é…ç½®æœåŠ¡
import { ConfigService } from "@hl8/config";

@Injectable()
export class DatabaseService {
  constructor(private readonly configService: ConfigService) {}
  
  public getConnectionString(): string {
    return this.configService.get("DATABASE_URL") || 
           this.configService.get("database.url");
  }
}
```

#### 3.3.9 NestJS-Fastify ç»„ä»¶ï¼ˆLoggingï¼‰

**å¿…é¡»ä¼˜å…ˆä½¿ç”¨** `@hl8/nestjs-fastify` æä¾›çš„ logging ç»„ä»¶ï¼š

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ nestjs-fastify çš„ logging
import { Logger } from "@hl8/nestjs-fastify";

@Injectable()
export class UserService {
  private readonly logger = new Logger(UserService.name);
  
  public async createUser(data: CreateUserDto): Promise<User> {
    this.logger.log(`Creating user: ${data.email}`);
    
    try {
      const user = await this.userRepository.create(data);
      this.logger.log(`User created successfully: ${user.id}`);
      return user;
    } catch (error) {
      this.logger.error(`Failed to create user: ${error.message}`, error.stack);
      throw error;
    }
  }
}
```

```typescript
// âŒ é”™è¯¯ï¼šè‡ªå·±å®ç° logging
console.log("Creating user"); // ä¸åº”è¯¥ä½¿ç”¨ console.log
const logger = new CustomLogger(); // ä¸åº”è¯¥è‡ªå·±å®ç° logger
```

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ IsolationContext
import { IsolationContext, SharingLevel } from "@hl8/domain-kernel";

export class UserRepository {
  public async findByTenant(
    tenantId: TenantId,
    context: IsolationContext
  ): Promise<User[]> {
    // ä½¿ç”¨ context è¿›è¡Œæ•°æ®éš”ç¦»
    return this.query({
      tenantId: context.tenantId.value,
      organizationId: context.organizationId?.value,
      departmentId: context.departmentId?.value,
    });
  }
}
```

```typescript
// âŒ é”™è¯¯ï¼šä¸ä½¿ç”¨ IsolationContext
export class UserRepository {
  public async findByTenant(tenantId: string): Promise<User[]> {
    // æ²¡æœ‰ä½¿ç”¨éš”ç¦»æœºåˆ¶
  }
}
```

#### 3.3.10 å®Œæ•´çš„å¯¼å…¥ç¤ºä¾‹

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„å®ä½“å®ç°ç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•æ­£ç¡®ä½¿ç”¨ domain-kernel çš„ç»„ä»¶ï¼š

```typescript
import { 
  BaseEntity, 
  EntityId,
  TenantId,
  OrganizationId,
  UserId,
  IsolationContext,
  SharingLevel
} from "@hl8/domain-kernel";

/**
 * ç”¨æˆ·å®ä½“
 * 
 * @description ç”¨æˆ·å®ä½“ï¼Œç»§æ‰¿ BaseEntity
 */
export class User extends BaseEntity {
  private _email: Email;
  private _organizationId: OrganizationId | null;
  
  constructor(
    id: UserId,
    tenantId: TenantId,
    email: Email,
    organizationId?: OrganizationId
  ) {
    super(id, tenantId);
    this._email = email;
    this._organizationId = organizationId || null;
  }

  public get email(): Email {
    return this._email;
  }

  public get organizationId(): OrganizationId | null {
    return this._organizationId;
  }

  /**
   * åˆ†é…ç»„ç»‡
   */
  public assignToOrganization(organizationId: OrganizationId): void {
    this._organizationId = organizationId;
    this.updateTimestamp();
  }
}
```

#### 3.3.11 é”™è¯¯ç¤ºä¾‹å’Œå¸¸è§é—®é¢˜

**é—®é¢˜ 1: é‡å¤å®šä¹‰ ID å€¼å¯¹è±¡**

```typescript
// âŒ é”™è¯¯ï¼šè‡ªå·±å®šä¹‰ TenantId
export class TenantId extends BaseValueObject {
  constructor(private readonly value: string) {
    super();
  }
}

// âœ… æ­£ç¡®ï¼šä» domain-kernel å¯¼å…¥
import { TenantId } from "@hl8/domain-kernel";
```

**é—®é¢˜ 2: ä¸ä½¿ç”¨ IsolationContext**

```typescript
// âŒ é”™è¯¯ï¼šç›´æ¥ä¼ é€’ ID
public async findUsers(tenantId: string): Promise<User[]> {
  return this.repository.find({ tenantId });
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ IsolationContext
public async findUsers(context: IsolationContext): Promise<User[]> {
  return this.repository.find({
    tenantId: context.tenantId.value,
  });
}
```

**é—®é¢˜ 3: è‡ªå·±å®ç° BaseEntity**

```typescript
// âŒ é”™è¯¯ï¼šè‡ªå·±å®ç° BaseEntity
export abstract class BaseEntity {
  protected readonly _id: EntityId;
  // ... é‡å¤å®ç°
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ domain-kernel çš„ BaseEntity
import { BaseEntity } from "@hl8/domain-kernel";
```

---

## 4. å¼€å‘æµç¨‹

### 4.1 å¼€å‘é˜¶æ®µ

#### 4.1.1 éœ€æ±‚åˆ†æé˜¶æ®µ

1. **ä¸šåŠ¡éœ€æ±‚åˆ†æ**
   - ç†è§£ä¸šåŠ¡éœ€æ±‚
   - è¯†åˆ«ä¸šåŠ¡è§„åˆ™
   - å®šä¹‰ä¸šåŠ¡æµç¨‹

2. **æŠ€æœ¯éœ€æ±‚åˆ†æ**
   - ç¡®å®šæŠ€æœ¯æ¶æ„
   - é€‰æ‹©æŠ€æœ¯æ ˆ
   - è®¾è®¡æ¥å£è§„èŒƒ

3. **éœ€æ±‚æ–‡æ¡£ç¼–å†™**
   - ä¸šåŠ¡éœ€æ±‚æ–‡æ¡£
   - æŠ€æœ¯éœ€æ±‚æ–‡æ¡£
   - æ¥å£è®¾è®¡æ–‡æ¡£

#### 4.1.2 è®¾è®¡é˜¶æ®µ

1. **é¢†åŸŸå»ºæ¨¡**
   - è¯†åˆ«é¢†åŸŸå®ä½“
   - å®šä¹‰èšåˆæ ¹
   - è®¾è®¡å€¼å¯¹è±¡

2. **æ¶æ„è®¾è®¡**
   - å››å±‚æ¶æ„è®¾è®¡
   - æ¥å£è®¾è®¡
   - æ•°æ®æ¨¡å‹è®¾è®¡

3. **è®¾è®¡æ–‡æ¡£ç¼–å†™**
   - æ¶æ„è®¾è®¡æ–‡æ¡£
   - æ•°æ®åº“è®¾è®¡æ–‡æ¡£
   - APIè®¾è®¡æ–‡æ¡£

#### 4.1.3 å¼€å‘é˜¶æ®µ

1. **é¢†åŸŸå±‚å¼€å‘**
   - å®ä½“å®ç°
   - èšåˆæ ¹å®ç°
   - é¢†åŸŸæœåŠ¡å®ç°

2. **åº”ç”¨å±‚å¼€å‘**
   - ç”¨ä¾‹å®ç°
   - å‘½ä»¤æŸ¥è¯¢å®ç°
   - åº”ç”¨æœåŠ¡å®ç°

3. **åŸºç¡€è®¾æ–½å±‚å¼€å‘**
   - ä»“å‚¨å®ç°
   - å¤–éƒ¨æœåŠ¡å®ç°
   - æ¶ˆæ¯é˜Ÿåˆ—å®ç°

4. **æ¥å£å±‚å¼€å‘**
   - æ§åˆ¶å™¨å®ç°
   - ä¸­é—´ä»¶å®ç°
   - å®ˆå«å®ç°

#### 4.1.4 æµ‹è¯•é˜¶æ®µ

1. **å•å…ƒæµ‹è¯•**
   - é¢†åŸŸå±‚æµ‹è¯•
   - åº”ç”¨å±‚æµ‹è¯•
   - åŸºç¡€è®¾æ–½å±‚æµ‹è¯•

2. **é›†æˆæµ‹è¯•**
   - æ¨¡å—é›†æˆæµ‹è¯•
   - ç³»ç»Ÿé›†æˆæµ‹è¯•
   - æ€§èƒ½æµ‹è¯•

3. **ç«¯åˆ°ç«¯æµ‹è¯•**
   - ç”¨æˆ·åœºæ™¯æµ‹è¯•
   - ä¸šåŠ¡æµç¨‹æµ‹è¯•
   - å¼‚å¸¸æƒ…å†µæµ‹è¯•

#### 4.1.5 éƒ¨ç½²é˜¶æ®µ

1. **ç¯å¢ƒå‡†å¤‡**
   - å¼€å‘ç¯å¢ƒ
   - æµ‹è¯•ç¯å¢ƒ
   - ç”Ÿäº§ç¯å¢ƒ

2. **éƒ¨ç½²é…ç½®**
   - åº”ç”¨é…ç½®
   - æ•°æ®åº“é…ç½®
   - ç¼“å­˜é…ç½®

3. **ç›‘æ§é…ç½®**
   - æ—¥å¿—ç›‘æ§
   - æ€§èƒ½ç›‘æ§
   - é”™è¯¯ç›‘æ§

### 4.2 å¼€å‘è§„èŒƒ

#### 4.2.1 ä»£ç è§„èŒƒ

- **å‘½åè§„èŒƒ**: ä½¿ç”¨æœ‰æ„ä¹‰çš„å‘½å
- **æ³¨é‡Šè§„èŒƒ**: éµå¾ªTSDocè§„èŒƒ
- **ç±»å‹è§„èŒƒ**: ä½¿ç”¨TypeScriptç±»å‹
- **é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†

#### 4.2.2 æäº¤è§„èŒƒ

ä½¿ç”¨Conventional Commitsè§„èŒƒï¼š

```
feat: æ–°åŠŸèƒ½
fix: ä¿®å¤bug
docs: æ–‡æ¡£æ›´æ–°
style: ä»£ç æ ¼å¼
refactor: é‡æ„
test: æµ‹è¯•
chore: æ„å»ºè¿‡ç¨‹æˆ–è¾…åŠ©å·¥å…·çš„å˜åŠ¨
```

#### 4.2.3 åˆ†æ”¯è§„èŒƒ

- **main**: ä¸»åˆ†æ”¯ï¼Œç”Ÿäº§ç¯å¢ƒä»£ç 
- **develop**: å¼€å‘åˆ†æ”¯ï¼Œå¼€å‘ç¯å¢ƒä»£ç 
- **feature/**: åŠŸèƒ½åˆ†æ”¯ï¼Œæ–°åŠŸèƒ½å¼€å‘
- **hotfix/**: çƒ­ä¿®å¤åˆ†æ”¯ï¼Œç´§æ€¥ä¿®å¤
- **release/**: å‘å¸ƒåˆ†æ”¯ï¼Œç‰ˆæœ¬å‘å¸ƒ

---

## 5. ä»£ç å®ç°æŒ‡å—

### 5.1 é¢†åŸŸå±‚å®ç°

#### 5.1.1 å®ä½“å®ç°

````typescript
/**
 * ç”¨æˆ·å®ä½“
 *
 * @description ç”¨æˆ·ä¸šåŠ¡å®ä½“ï¼ŒåŒ…å«ç”¨æˆ·ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘
 * éµå¾ªå……è¡€æ¨¡å‹è®¾è®¡ï¼Œå®ä½“åŒ…å«ä¸šåŠ¡é€»è¾‘è€Œä¸ä»…ä»…æ˜¯æ•°æ®å®¹å™¨
 *
 * @example
 * ```typescript
 * const user = new User(
 *   new UserId('user-123'),
 *   new Email('user@example.com'),
 *   new Username('john_doe')
 * );
 *
 * user.changeEmail(new Email('new@example.com'));
 * user.activate();
 * ```
 */
export class User extends BaseEntity {
  private _email: Email;
  private _username: Username;
  private _status: UserStatus;
  private _profile: UserProfile;

  constructor(
    id: UserId,
    email: Email,
    username: Username,
    profile?: UserProfile,
  ) {
    super(id);
    this._email = email;
    this._username = username;
    this._status = UserStatus.PENDING;
    this._profile = profile || UserProfile.createDefault();

    // å‘å¸ƒç”¨æˆ·åˆ›å»ºäº‹ä»¶
    this.addDomainEvent(
      new UserCreatedEvent(this.id, this.email, this.username),
    );
  }

  /**
   * è·å–ç”¨æˆ·é‚®ç®±
   *
   * @returns ç”¨æˆ·é‚®ç®±
   */
  public get email(): Email {
    return this._email;
  }

  /**
   * è·å–ç”¨æˆ·çŠ¶æ€
   *
   * @returns ç”¨æˆ·çŠ¶æ€
   */
  public get status(): UserStatus {
    return this._status;
  }

  /**
   * æ›´æ”¹ç”¨æˆ·é‚®ç®±
   *
   * @param newEmail æ–°é‚®ç®±
   * @throws InvalidEmailException é‚®ç®±æ ¼å¼æ— æ•ˆæ—¶æŠ›å‡º
   * @throws UserNotActiveException ç”¨æˆ·æœªæ¿€æ´»æ—¶æŠ›å‡º
   *
   * @example
   * ```typescript
   * user.changeEmail(new Email('new@example.com'));
   * ```
   */
  public changeEmail(newEmail: Email): void {
    // ä¸šåŠ¡è§„åˆ™éªŒè¯
    if (!this.isActive()) {
      throw new UserNotActiveException(this.id);
    }

    if (this._email.equals(newEmail)) {
      return; // ç›¸åŒé‚®ç®±ï¼Œæ— éœ€æ›´æ”¹
    }

    // æ‰§è¡Œé‚®ç®±æ›´æ”¹
    const oldEmail = this._email;
    this._email = newEmail;

    // å‘å¸ƒé‚®ç®±æ›´æ”¹äº‹ä»¶
    this.addDomainEvent(new UserEmailChangedEvent(this.id, oldEmail, newEmail));
  }

  /**
   * æ¿€æ´»ç”¨æˆ·
   *
   * @throws UserAlreadyActiveException ç”¨æˆ·å·²æ¿€æ´»æ—¶æŠ›å‡º
   *
   * @example
   * ```typescript
   * user.activate();
   * ```
   */
  public activate(): void {
    if (this.isActive()) {
      throw new UserAlreadyActiveException(this.id);
    }

    this._status = UserStatus.ACTIVE;
    this.addDomainEvent(new UserActivatedEvent(this.id));
  }

  /**
   * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ¿€æ´»
   *
   * @returns æ˜¯å¦æ¿€æ´»
   */
  public isActive(): boolean {
    return this._status === UserStatus.ACTIVE;
  }

  /**
   * æ›´æ–°ç”¨æˆ·èµ„æ–™
   *
   * @param profile ç”¨æˆ·èµ„æ–™
   * @throws UserNotActiveException ç”¨æˆ·æœªæ¿€æ´»æ—¶æŠ›å‡º
   */
  public updateProfile(profile: UserProfile): void {
    if (!this.isActive()) {
      throw new UserNotActiveException(this.id);
    }

    this._profile = profile;
    this.addDomainEvent(new UserProfileUpdatedEvent(this.id, profile));
  }
}
````

#### 5.1.2 èšåˆæ ¹å®ç°

````typescript
/**
 * è®¢å•èšåˆæ ¹
 *
 * @description è®¢å•èšåˆæ ¹ï¼Œç®¡ç†è®¢å•ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘
 * è´Ÿè´£ç»´æŠ¤è®¢å•çš„ä¸€è‡´æ€§è¾¹ç•Œå’Œä¸šåŠ¡è§„åˆ™
 *
 * @example
 * ```typescript
 * const order = new Order(
 *   new OrderId('order-123'),
 *   new CustomerId('customer-456'),
 *   [orderItem1, orderItem2]
 * );
 *
 * order.addItem(new OrderItem(...));
 * order.confirm();
 * ```
 */
export class Order extends AggregateRoot {
  private _customerId: CustomerId;
  private _items: OrderItem[];
  private _status: OrderStatus;
  private _totalAmount: Money;
  private _shippingAddress: Address;

  constructor(id: OrderId, customerId: CustomerId, items: OrderItem[] = []) {
    super(id);
    this._customerId = customerId;
    this._items = [...items];
    this._status = OrderStatus.DRAFT;
    this._totalAmount = this.calculateTotalAmount();

    // éªŒè¯ä¸šåŠ¡è§„åˆ™
    this.validateOrderRules();

    // å‘å¸ƒè®¢å•åˆ›å»ºäº‹ä»¶
    this.addDomainEvent(new OrderCreatedEvent(this.id, this.customerId));
  }

  /**
   * æ·»åŠ è®¢å•é¡¹
   *
   * @param item è®¢å•é¡¹
   * @throws OrderClosedException è®¢å•å·²å…³é—­æ—¶æŠ›å‡º
   * @throws InvalidOrderItemException è®¢å•é¡¹æ— æ•ˆæ—¶æŠ›å‡º
   */
  public addItem(item: OrderItem): void {
    // ä¸šåŠ¡è§„åˆ™éªŒè¯
    if (this.isClosed()) {
      throw new OrderClosedException(this.id);
    }

    if (!item.isValid()) {
      throw new InvalidOrderItemException(item);
    }

    // æ·»åŠ è®¢å•é¡¹
    this._items.push(item);
    this._totalAmount = this.calculateTotalAmount();

    // å‘å¸ƒè®¢å•é¡¹æ·»åŠ äº‹ä»¶
    this.addDomainEvent(new OrderItemAddedEvent(this.id, item));
  }

  /**
   * ç¡®è®¤è®¢å•
   *
   * @throws OrderClosedException è®¢å•å·²å…³é—­æ—¶æŠ›å‡º
   * @throws EmptyOrderException è®¢å•ä¸ºç©ºæ—¶æŠ›å‡º
   */
  public confirm(): void {
    if (this.isClosed()) {
      throw new OrderClosedException(this.id);
    }

    if (this._items.length === 0) {
      throw new EmptyOrderException(this.id);
    }

    this._status = OrderStatus.CONFIRMED;
    this.addDomainEvent(new OrderConfirmedEvent(this.id, this._totalAmount));
  }

  /**
   * æ£€æŸ¥è®¢å•æ˜¯å¦å·²å…³é—­
   *
   * @returns æ˜¯å¦å·²å…³é—­
   */
  public isClosed(): boolean {
    return (
      this._status === OrderStatus.CANCELLED ||
      this._status === OrderStatus.COMPLETED
    );
  }

  /**
   * è®¡ç®—è®¢å•æ€»é‡‘é¢
   *
   * @returns æ€»é‡‘é¢
   */
  private calculateTotalAmount(): Money {
    return this._items.reduce(
      (total, item) => total.add(item.getSubtotal()),
      Money.zero(),
    );
  }

  /**
   * éªŒè¯è®¢å•ä¸šåŠ¡è§„åˆ™
   *
   * @throws BusinessRuleValidationException ä¸šåŠ¡è§„åˆ™éªŒè¯å¤±è´¥æ—¶æŠ›å‡º
   */
  private validateOrderRules(): void {
    const rules = [
      new OrderAmountRule(this._totalAmount),
      new OrderItemCountRule(this._items.length),
      new OrderCustomerRule(this._customerId),
    ];

    for (const rule of rules) {
      const result = rule.validate();
      if (!result.isValid) {
        throw new BusinessRuleValidationException(result.errors);
      }
    }
  }
}
````

#### 5.1.3 å€¼å¯¹è±¡å®ç°

````typescript
/**
 * é‚®ç®±å€¼å¯¹è±¡
 *
 * @description é‚®ç®±å€¼å¯¹è±¡ï¼Œè¡¨ç¤ºç”¨æˆ·é‚®ç®±åœ°å€
 * æä¾›é‚®ç®±æ ¼å¼éªŒè¯å’Œä¸å¯å˜æ€§ä¿è¯
 *
 * @example
 * ```typescript
 * const email = new Email('user@example.com');
 * console.log(email.value); // 'user@example.com'
 * console.log(email.domain); // 'example.com'
 * ```
 */
export class Email extends BaseValueObject {
  private readonly _value: string;
  private readonly _domain: string;
  private readonly _localPart: string;

  constructor(value: string) {
    super();
    this.validateEmail(value);
    this._value = value.toLowerCase().trim();
    [this._localPart, this._domain] = this._value.split("@");
  }

  /**
   * è·å–é‚®ç®±å€¼
   *
   * @returns é‚®ç®±å€¼
   */
  public get value(): string {
    return this._value;
  }

  /**
   * è·å–é‚®ç®±åŸŸå
   *
   * @returns åŸŸå
   */
  public get domain(): string {
    return this._domain;
  }

  /**
   * è·å–é‚®ç®±æœ¬åœ°éƒ¨åˆ†
   *
   * @returns æœ¬åœ°éƒ¨åˆ†
   */
  public get localPart(): string {
    return this._localPart;
  }

  /**
   * éªŒè¯é‚®ç®±æ ¼å¼
   *
   * @param email é‚®ç®±åœ°å€
   * @throws InvalidEmailException é‚®ç®±æ ¼å¼æ— æ•ˆæ—¶æŠ›å‡º
   */
  private validateEmail(email: string): void {
    if (!email || typeof email !== "string") {
      throw new InvalidEmailException("é‚®ç®±åœ°å€ä¸èƒ½ä¸ºç©º");
    }

    const trimmedEmail = email.trim();
    if (trimmedEmail.length === 0) {
      throw new InvalidEmailException("é‚®ç®±åœ°å€ä¸èƒ½ä¸ºç©º");
    }

    if (trimmedEmail.length > 254) {
      throw new InvalidEmailException("é‚®ç®±åœ°å€é•¿åº¦ä¸èƒ½è¶…è¿‡254ä¸ªå­—ç¬¦");
    }

    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    if (!emailRegex.test(trimmedEmail)) {
      throw new InvalidEmailException("é‚®ç®±åœ°å€æ ¼å¼æ— æ•ˆ");
    }
  }

  /**
   * æ¯”è¾ƒé‚®ç®±æ˜¯å¦ç›¸ç­‰
   *
   * @param other å…¶ä»–é‚®ç®±å¯¹è±¡
   * @returns æ˜¯å¦ç›¸ç­‰
   */
  public equals(other: Email): boolean {
    if (!(other instanceof Email)) {
      return false;
    }

    return this._value === other._value;
  }

  /**
   * è½¬æ¢ä¸ºå­—ç¬¦ä¸²
   *
   * @returns å­—ç¬¦ä¸²è¡¨ç¤º
   */
  public toString(): string {
    return this._value;
  }
}
````

### 5.2 åº”ç”¨å±‚å®ç°

#### 5.2.1 ç”¨ä¾‹å®ç°

````typescript
/**
 * åˆ›å»ºç”¨æˆ·ç”¨ä¾‹
 *
 * @description åˆ›å»ºæ–°ç”¨æˆ·çš„ä¸šåŠ¡ç”¨ä¾‹
 * åè°ƒé¢†åŸŸå±‚å’ŒåŸºç¡€è®¾æ–½å±‚ï¼Œå®ç°ç”¨æˆ·åˆ›å»ºçš„ä¸šåŠ¡æµç¨‹
 *
 * @example
 * ```typescript
 * const useCase = new CreateUserUseCase(
 *   userRepository,
 *   eventBus,
 *   emailService
 * );
 *
 * const response = await useCase.execute({
 *   email: 'user@example.com',
 *   username: 'john_doe',
 *   password: 'password123'
 * });
 * ```
 */
export class CreateUserUseCase extends BaseUseCase {
  constructor(
    private readonly userRepository: IUserRepository,
    private readonly eventBus: IEventBus,
    private readonly emailService: IEmailService,
    private readonly passwordService: IPasswordService,
  ) {
    super();
  }

  /**
   * æ‰§è¡Œåˆ›å»ºç”¨æˆ·ç”¨ä¾‹
   *
   * @param request åˆ›å»ºç”¨æˆ·è¯·æ±‚
   * @returns åˆ›å»ºç”¨æˆ·å“åº”
   * @throws ValidationException éªŒè¯å¤±è´¥æ—¶æŠ›å‡º
   * @throws DuplicateUserException ç”¨æˆ·å·²å­˜åœ¨æ—¶æŠ›å‡º
   * @throws EmailServiceException é‚®ä»¶æœåŠ¡å¼‚å¸¸æ—¶æŠ›å‡º
   */
  public async execute(
    request: CreateUserRequest,
  ): Promise<CreateUserResponse> {
    // 1. éªŒè¯è¾“å…¥
    this.validateRequest(request);

    // 2. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
    await this.checkUserExists(request.email, request.username);

    // 3. åˆ›å»ºç”¨æˆ·å®ä½“
    const user = this.createUser(request);

    // 4. ä¿å­˜ç”¨æˆ·
    await this.userRepository.save(user);

    // 5. å‘é€æ¬¢è¿é‚®ä»¶
    await this.sendWelcomeEmail(user);

    // 6. å‘å¸ƒé¢†åŸŸäº‹ä»¶
    await this.eventBus.publish(user.getDomainEvents());

    return new CreateUserResponse(user.id, user.email, user.username);
  }

  /**
   * éªŒè¯è¯·æ±‚å‚æ•°
   *
   * @param request è¯·æ±‚å¯¹è±¡
   * @throws ValidationException éªŒè¯å¤±è´¥æ—¶æŠ›å‡º
   */
  private validateRequest(request: CreateUserRequest): void {
    const errors: ValidationError[] = [];

    if (!request.email) {
      errors.push(new ValidationError("email", "é‚®ç®±åœ°å€ä¸èƒ½ä¸ºç©º"));
    }

    if (!request.username) {
      errors.push(new ValidationError("username", "ç”¨æˆ·åä¸èƒ½ä¸ºç©º"));
    }

    if (!request.password) {
      errors.push(new ValidationError("password", "å¯†ç ä¸èƒ½ä¸ºç©º"));
    }

    if (errors.length > 0) {
      throw new ValidationException("è¯·æ±‚å‚æ•°éªŒè¯å¤±è´¥", errors);
    }
  }

  /**
   * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
   *
   * @param email é‚®ç®±åœ°å€
   * @param username ç”¨æˆ·å
   * @throws DuplicateUserException ç”¨æˆ·å·²å­˜åœ¨æ—¶æŠ›å‡º
   */
  private async checkUserExists(
    email: string,
    username: string,
  ): Promise<void> {
    const existingUser = await this.userRepository.findByEmailOrUsername(
      email,
      username,
    );
    if (existingUser) {
      throw new DuplicateUserException("ç”¨æˆ·å·²å­˜åœ¨");
    }
  }

  /**
   * åˆ›å»ºç”¨æˆ·å®ä½“
   *
   * @param request è¯·æ±‚å¯¹è±¡
   * @returns ç”¨æˆ·å®ä½“
   */
  private createUser(request: CreateUserRequest): User {
    const userId = new UserId(uuid());
    const email = new Email(request.email);
    const username = new Username(request.username);
    const hashedPassword = this.passwordService.hash(request.password);

    return new User(userId, email, username, hashedPassword);
  }

  /**
   * å‘é€æ¬¢è¿é‚®ä»¶
   *
   * @param user ç”¨æˆ·å®ä½“
   * @throws EmailServiceException é‚®ä»¶æœåŠ¡å¼‚å¸¸æ—¶æŠ›å‡º
   */
  private async sendWelcomeEmail(user: User): Promise<void> {
    const emailMessage = new EmailMessage({
      to: user.email.value,
      subject: "æ¬¢è¿æ³¨å†ŒHL8å¹³å°",
      body: `æ¬¢è¿ ${user.username.value} æ³¨å†ŒHL8å¹³å°ï¼`,
    });

    await this.emailService.sendEmail(emailMessage);
  }
}
````

#### 5.2.2 å‘½ä»¤å¤„ç†å™¨å®ç°

````typescript
/**
 * åˆ›å»ºç”¨æˆ·å‘½ä»¤å¤„ç†å™¨
 *
 * @description å¤„ç†åˆ›å»ºç”¨æˆ·å‘½ä»¤
 * å®ç°CQRSæ¨¡å¼çš„å‘½ä»¤å¤„ç†é€»è¾‘
 *
 * @example
 * ```typescript
 * const handler = new CreateUserCommandHandler(
 *   userRepository,
 *   eventBus,
 *   emailService
 * );
 *
 * const response = await handler.handle(new CreateUserCommand(
 *   'user@example.com',
 *   'john_doe',
 *   'password123'
 * ));
 * ```
 */
export class CreateUserCommandHandler
  implements CommandHandler<CreateUserCommand, CreateUserResponse>
{
  constructor(
    private readonly userRepository: IUserRepository,
    private readonly eventBus: IEventBus,
    private readonly emailService: IEmailService,
  ) {}

  /**
   * å¤„ç†åˆ›å»ºç”¨æˆ·å‘½ä»¤
   *
   * @param command åˆ›å»ºç”¨æˆ·å‘½ä»¤
   * @returns åˆ›å»ºç”¨æˆ·å“åº”
   * @throws ValidationException éªŒè¯å¤±è´¥æ—¶æŠ›å‡º
   * @throws DuplicateUserException ç”¨æˆ·å·²å­˜åœ¨æ—¶æŠ›å‡º
   */
  public async handle(command: CreateUserCommand): Promise<CreateUserResponse> {
    // 1. éªŒè¯å‘½ä»¤
    this.validateCommand(command);

    // 2. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
    await this.checkUserExists(command.email, command.username);

    // 3. åˆ›å»ºç”¨æˆ·å®ä½“
    const user = this.createUser(command);

    // 4. ä¿å­˜ç”¨æˆ·
    await this.userRepository.save(user);

    // 5. å‘é€æ¬¢è¿é‚®ä»¶
    await this.sendWelcomeEmail(user);

    // 6. å‘å¸ƒé¢†åŸŸäº‹ä»¶
    await this.eventBus.publish(user.getDomainEvents());

    return new CreateUserResponse(user.id, user.email, user.username);
  }

  /**
   * éªŒè¯å‘½ä»¤
   *
   * @param command å‘½ä»¤å¯¹è±¡
   * @throws ValidationException éªŒè¯å¤±è´¥æ—¶æŠ›å‡º
   */
  private validateCommand(command: CreateUserCommand): void {
    const errors: ValidationError[] = [];

    if (!command.email) {
      errors.push(new ValidationError("email", "é‚®ç®±åœ°å€ä¸èƒ½ä¸ºç©º"));
    }

    if (!command.username) {
      errors.push(new ValidationError("username", "ç”¨æˆ·åä¸èƒ½ä¸ºç©º"));
    }

    if (!command.password) {
      errors.push(new ValidationError("password", "å¯†ç ä¸èƒ½ä¸ºç©º"));
    }

    if (errors.length > 0) {
      throw new ValidationException("å‘½ä»¤éªŒè¯å¤±è´¥", errors);
    }
  }

  /**
   * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
   *
   * @param email é‚®ç®±åœ°å€
   * @param username ç”¨æˆ·å
   * @throws DuplicateUserException ç”¨æˆ·å·²å­˜åœ¨æ—¶æŠ›å‡º
   */
  private async checkUserExists(
    email: string,
    username: string,
  ): Promise<void> {
    const existingUser = await this.userRepository.findByEmailOrUsername(
      email,
      username,
    );
    if (existingUser) {
      throw new DuplicateUserException("ç”¨æˆ·å·²å­˜åœ¨");
    }
  }

  /**
   * åˆ›å»ºç”¨æˆ·å®ä½“
   *
   * @param command å‘½ä»¤å¯¹è±¡
   * @returns ç”¨æˆ·å®ä½“
   */
  private createUser(command: CreateUserCommand): User {
    const userId = new UserId(uuid());
    const email = new Email(command.email);
    const username = new Username(command.username);

    return new User(userId, email, username);
  }

  /**
   * å‘é€æ¬¢è¿é‚®ä»¶
   *
   * @param user ç”¨æˆ·å®ä½“
   * @throws EmailServiceException é‚®ä»¶æœåŠ¡å¼‚å¸¸æ—¶æŠ›å‡º
   */
  private async sendWelcomeEmail(user: User): Promise<void> {
    const emailMessage = new EmailMessage({
      to: user.email.value,
      subject: "æ¬¢è¿æ³¨å†ŒHL8å¹³å°",
      body: `æ¬¢è¿ ${user.username.value} æ³¨å†ŒHL8å¹³å°ï¼`,
    });

    await this.emailService.sendEmail(emailMessage);
  }
}
````

### 5.3 åŸºç¡€è®¾æ–½å±‚å®ç°

#### 5.3.1 ä»“å‚¨å®ç°

````typescript
/**
 * ç”¨æˆ·ä»“å‚¨å®ç°
 *
 * @description ç”¨æˆ·ä»“å‚¨çš„æ•°æ®åº“å®ç°
 * å®ç°é¢†åŸŸå±‚å®šä¹‰çš„ä»“å‚¨æ¥å£ï¼Œè´Ÿè´£ç”¨æˆ·æ•°æ®çš„æŒä¹…åŒ–
 *
 * @example
 * ```typescript
 * const repository = new UserRepository(
 *   entityManager,
 *   isolationContext
 * );
 *
 * await repository.save(user);
 * const foundUser = await repository.findById(userId);
 * ```
 */
export class UserRepository implements IUserRepository {
  constructor(
    private readonly entityManager: EntityManager,
    private readonly isolationContext: IsolationContext,
  ) {}

  /**
   * ä¿å­˜ç”¨æˆ·
   *
   * @param user ç”¨æˆ·å®ä½“
   * @throws DatabaseException æ•°æ®åº“å¼‚å¸¸æ—¶æŠ›å‡º
   */
  public async save(user: User): Promise<void> {
    try {
      const userEntity = this.mapToEntity(user);
      await this.entityManager.persistAndFlush(userEntity);
    } catch (error) {
      throw new DatabaseException("ä¿å­˜ç”¨æˆ·å¤±è´¥", error);
    }
  }

  /**
   * æ ¹æ®IDæŸ¥æ‰¾ç”¨æˆ·
   *
   * @param id ç”¨æˆ·ID
   * @returns ç”¨æˆ·å®ä½“æˆ–null
   * @throws DatabaseException æ•°æ®åº“å¼‚å¸¸æ—¶æŠ›å‡º
   */
  public async findById(id: UserId): Promise<User | null> {
    try {
      const userEntity = await this.entityManager.findOne(UserEntity, {
        id: id.value,
        tenantId: this.isolationContext.tenantId.value,
      });

      return userEntity ? this.mapToDomain(userEntity) : null;
    } catch (error) {
      throw new DatabaseException("æŸ¥æ‰¾ç”¨æˆ·å¤±è´¥", error);
    }
  }

  /**
   * æ ¹æ®é‚®ç®±æˆ–ç”¨æˆ·åæŸ¥æ‰¾ç”¨æˆ·
   *
   * @param email é‚®ç®±åœ°å€
   * @param username ç”¨æˆ·å
   * @returns ç”¨æˆ·å®ä½“æˆ–null
   * @throws DatabaseException æ•°æ®åº“å¼‚å¸¸æ—¶æŠ›å‡º
   */
  public async findByEmailOrUsername(
    email: string,
    username: string,
  ): Promise<User | null> {
    try {
      const userEntity = await this.entityManager.findOne(UserEntity, {
        $or: [{ email: email }, { username: username }],
        tenantId: this.isolationContext.tenantId.value,
      });

      return userEntity ? this.mapToDomain(userEntity) : null;
    } catch (error) {
      throw new DatabaseException("æŸ¥æ‰¾ç”¨æˆ·å¤±è´¥", error);
    }
  }

  /**
   * åˆ é™¤ç”¨æˆ·
   *
   * @param id ç”¨æˆ·ID
   * @throws DatabaseException æ•°æ®åº“å¼‚å¸¸æ—¶æŠ›å‡º
   */
  public async delete(id: UserId): Promise<void> {
    try {
      const userEntity = await this.entityManager.findOne(UserEntity, {
        id: id.value,
        tenantId: this.isolationContext.tenantId.value,
      });

      if (userEntity) {
        await this.entityManager.removeAndFlush(userEntity);
      }
    } catch (error) {
      throw new DatabaseException("åˆ é™¤ç”¨æˆ·å¤±è´¥", error);
    }
  }

  /**
   * å°†é¢†åŸŸå¯¹è±¡æ˜ å°„ä¸ºå®ä½“
   *
   * @param user ç”¨æˆ·é¢†åŸŸå¯¹è±¡
   * @returns ç”¨æˆ·å®ä½“
   */
  private mapToEntity(user: User): UserEntity {
    const userEntity = new UserEntity();
    userEntity.id = user.id.value;
    userEntity.email = user.email.value;
    userEntity.username = user.username.value;
    userEntity.status = user.status;
    userEntity.tenantId = this.isolationContext.tenantId.value;
    userEntity.organizationId = this.isolationContext.organizationId?.value;
    userEntity.departmentId = this.isolationContext.departmentId?.value;
    userEntity.createdAt = user.auditInfo.createdAt;
    userEntity.updatedAt = user.auditInfo.updatedAt;

    return userEntity;
  }

  /**
   * å°†å®ä½“æ˜ å°„ä¸ºé¢†åŸŸå¯¹è±¡
   *
   * @param userEntity ç”¨æˆ·å®ä½“
   * @returns ç”¨æˆ·é¢†åŸŸå¯¹è±¡
   */
  private mapToDomain(userEntity: UserEntity): User {
    const userId = new UserId(userEntity.id);
    const email = new Email(userEntity.email);
    const username = new Username(userEntity.username);

    const user = new User(userId, email, username);

    // è®¾ç½®ç”¨æˆ·çŠ¶æ€
    if (userEntity.status === UserStatus.ACTIVE) {
      user.activate();
    }

    return user;
  }
}
````

### 5.4 æ¥å£å±‚å®ç°

#### 5.4.1 æ§åˆ¶å™¨å®ç°

````typescript
/**
 * ç”¨æˆ·æ§åˆ¶å™¨
 *
 * @description ç”¨æˆ·ç›¸å…³çš„REST APIç«¯ç‚¹
 * å¤„ç†ç”¨æˆ·ç›¸å…³çš„HTTPè¯·æ±‚ï¼Œåè°ƒåº”ç”¨å±‚æœåŠ¡
 *
 * @example
 * ```typescript
 * // åˆ›å»ºç”¨æˆ·
 * POST /api/users
 * {
 *   "email": "user@example.com",
 *   "username": "john_doe",
 *   "password": "password123"
 * }
 *
 * // è·å–ç”¨æˆ·
 * GET /api/users/:id
 * ```
 */
@Controller("users")
export class UserController {
  constructor(
    private readonly createUserUseCase: CreateUserUseCase,
    private readonly getUserUseCase: GetUserUseCase,
    private readonly updateUserUseCase: UpdateUserUseCase,
    private readonly deleteUserUseCase: DeleteUserUseCase,
  ) {}

  /**
   * åˆ›å»ºç”¨æˆ·
   *
   * @param request åˆ›å»ºç”¨æˆ·è¯·æ±‚
   * @returns åˆ›å»ºç”¨æˆ·å“åº”
   * @throws ValidationException éªŒè¯å¤±è´¥æ—¶æŠ›å‡º
   * @throws DuplicateUserException ç”¨æˆ·å·²å­˜åœ¨æ—¶æŠ›å‡º
   */
  @Post()
  @UseGuards(AuthenticationGuard)
  @ApiOperation({ summary: "åˆ›å»ºç”¨æˆ·" })
  @ApiResponse({
    status: 201,
    description: "ç”¨æˆ·åˆ›å»ºæˆåŠŸ",
    type: CreateUserResponse,
  })
  @ApiResponse({ status: 400, description: "è¯·æ±‚å‚æ•°æ— æ•ˆ" })
  @ApiResponse({ status: 409, description: "ç”¨æˆ·å·²å­˜åœ¨" })
  public async createUser(
    @Body() request: CreateUserRequest,
  ): Promise<CreateUserResponse> {
    return await this.createUserUseCase.execute(request);
  }

  /**
   * è·å–ç”¨æˆ·
   *
   * @param id ç”¨æˆ·ID
   * @returns ç”¨æˆ·ä¿¡æ¯
   * @throws UserNotFoundException ç”¨æˆ·ä¸å­˜åœ¨æ—¶æŠ›å‡º
   */
  @Get(":id")
  @UseGuards(AuthenticationGuard, AuthorizationGuard)
  @ApiOperation({ summary: "è·å–ç”¨æˆ·" })
  @ApiResponse({
    status: 200,
    description: "è·å–ç”¨æˆ·æˆåŠŸ",
    type: GetUserResponse,
  })
  @ApiResponse({ status: 404, description: "ç”¨æˆ·ä¸å­˜åœ¨" })
  public async getUser(@Param("id") id: string): Promise<GetUserResponse> {
    return await this.getUserUseCase.execute(new GetUserRequest(id));
  }

  /**
   * æ›´æ–°ç”¨æˆ·
   *
   * @param id ç”¨æˆ·ID
   * @param request æ›´æ–°ç”¨æˆ·è¯·æ±‚
   * @returns æ›´æ–°ç”¨æˆ·å“åº”
   * @throws UserNotFoundException ç”¨æˆ·ä¸å­˜åœ¨æ—¶æŠ›å‡º
   * @throws ValidationException éªŒè¯å¤±è´¥æ—¶æŠ›å‡º
   */
  @Put(":id")
  @UseGuards(AuthenticationGuard, AuthorizationGuard)
  @ApiOperation({ summary: "æ›´æ–°ç”¨æˆ·" })
  @ApiResponse({
    status: 200,
    description: "æ›´æ–°ç”¨æˆ·æˆåŠŸ",
    type: UpdateUserResponse,
  })
  @ApiResponse({ status: 404, description: "ç”¨æˆ·ä¸å­˜åœ¨" })
  @ApiResponse({ status: 400, description: "è¯·æ±‚å‚æ•°æ— æ•ˆ" })
  public async updateUser(
    @Param("id") id: string,
    @Body() request: UpdateUserRequest,
  ): Promise<UpdateUserResponse> {
    return await this.updateUserUseCase.execute(
      new UpdateUserRequest(id, request),
    );
  }

  /**
   * åˆ é™¤ç”¨æˆ·
   *
   * @param id ç”¨æˆ·ID
   * @returns åˆ é™¤ç”¨æˆ·å“åº”
   * @throws UserNotFoundException ç”¨æˆ·ä¸å­˜åœ¨æ—¶æŠ›å‡º
   */
  @Delete(":id")
  @UseGuards(AuthenticationGuard, AuthorizationGuard)
  @ApiOperation({ summary: "åˆ é™¤ç”¨æˆ·" })
  @ApiResponse({
    status: 200,
    description: "åˆ é™¤ç”¨æˆ·æˆåŠŸ",
    type: DeleteUserResponse,
  })
  @ApiResponse({ status: 404, description: "ç”¨æˆ·ä¸å­˜åœ¨" })
  public async deleteUser(
    @Param("id") id: string,
  ): Promise<DeleteUserResponse> {
    return await this.deleteUserUseCase.execute(new DeleteUserRequest(id));
  }
}
````

---

## 6. æµ‹è¯•ç­–ç•¥

### 6.1 æµ‹è¯•å±‚æ¬¡

#### 6.1.1 å•å…ƒæµ‹è¯•

**é¢†åŸŸå±‚æµ‹è¯•**:

```typescript
/**
 * ç”¨æˆ·å®ä½“æµ‹è¯•
 *
 * @description æµ‹è¯•ç”¨æˆ·å®ä½“çš„ä¸šåŠ¡é€»è¾‘
 * ç¡®ä¿ä¸šåŠ¡è§„åˆ™çš„æ­£ç¡®å®ç°
 */
describe("User Entity", () => {
  let user: User;
  let userId: UserId;
  let email: Email;
  let username: Username;

  beforeEach(() => {
    userId = new UserId("user-123");
    email = new Email("user@example.com");
    username = new Username("john_doe");
    user = new User(userId, email, username);
  });

  describe("ç”¨æˆ·åˆ›å»º", () => {
    it("åº”è¯¥åˆ›å»ºç”¨æˆ·å®ä½“", () => {
      expect(user).toBeDefined();
      expect(user.id).toEqual(userId);
      expect(user.email).toEqual(email);
      expect(user.username).toEqual(username);
      expect(user.status).toBe(UserStatus.PENDING);
    });

    it("åº”è¯¥å‘å¸ƒç”¨æˆ·åˆ›å»ºäº‹ä»¶", () => {
      const events = user.getDomainEvents();
      expect(events).toHaveLength(1);
      expect(events[0]).toBeInstanceOf(UserCreatedEvent);
    });
  });

  describe("é‚®ç®±æ›´æ”¹", () => {
    it("åº”è¯¥æ›´æ”¹ç”¨æˆ·é‚®ç®±", () => {
      const newEmail = new Email("new@example.com");
      user.changeEmail(newEmail);

      expect(user.email).toEqual(newEmail);
    });

    it("åº”è¯¥å‘å¸ƒé‚®ç®±æ›´æ”¹äº‹ä»¶", () => {
      const newEmail = new Email("new@example.com");
      user.changeEmail(newEmail);

      const events = user.getDomainEvents();
      expect(events).toHaveLength(2); // åˆ›å»ºäº‹ä»¶ + é‚®ç®±æ›´æ”¹äº‹ä»¶
      expect(events[1]).toBeInstanceOf(UserEmailChangedEvent);
    });

    it("ç”¨æˆ·æœªæ¿€æ´»æ—¶åº”è¯¥æŠ›å‡ºå¼‚å¸¸", () => {
      const newEmail = new Email("new@example.com");

      expect(() => user.changeEmail(newEmail)).toThrow(UserNotActiveException);
    });
  });

  describe("ç”¨æˆ·æ¿€æ´»", () => {
    it("åº”è¯¥æ¿€æ´»ç”¨æˆ·", () => {
      user.activate();

      expect(user.status).toBe(UserStatus.ACTIVE);
      expect(user.isActive()).toBe(true);
    });

    it("åº”è¯¥å‘å¸ƒç”¨æˆ·æ¿€æ´»äº‹ä»¶", () => {
      user.activate();

      const events = user.getDomainEvents();
      expect(events).toHaveLength(2); // åˆ›å»ºäº‹ä»¶ + æ¿€æ´»äº‹ä»¶
      expect(events[1]).toBeInstanceOf(UserActivatedEvent);
    });

    it("ç”¨æˆ·å·²æ¿€æ´»æ—¶åº”è¯¥æŠ›å‡ºå¼‚å¸¸", () => {
      user.activate();

      expect(() => user.activate()).toThrow(UserAlreadyActiveException);
    });
  });
});
```

**åº”ç”¨å±‚æµ‹è¯•**:

```typescript
/**
 * åˆ›å»ºç”¨æˆ·ç”¨ä¾‹æµ‹è¯•
 *
 * @description æµ‹è¯•åˆ›å»ºç”¨æˆ·ç”¨ä¾‹çš„ä¸šåŠ¡é€»è¾‘
 * ç¡®ä¿ç”¨ä¾‹çš„æ­£ç¡®å®ç°
 */
describe("CreateUserUseCase", () => {
  let useCase: CreateUserUseCase;
  let userRepository: jest.Mocked<IUserRepository>;
  let eventBus: jest.Mocked<IEventBus>;
  let emailService: jest.Mocked<IEmailService>;

  beforeEach(() => {
    userRepository = {
      save: jest.fn(),
      findById: jest.fn(),
      findByEmailOrUsername: jest.fn(),
      delete: jest.fn(),
    };

    eventBus = {
      publish: jest.fn(),
    };

    emailService = {
      sendEmail: jest.fn(),
    };

    useCase = new CreateUserUseCase(userRepository, eventBus, emailService);
  });

  describe("æ‰§è¡Œåˆ›å»ºç”¨æˆ·ç”¨ä¾‹", () => {
    it("åº”è¯¥æˆåŠŸåˆ›å»ºç”¨æˆ·", async () => {
      // Arrange
      const request = new CreateUserRequest(
        "user@example.com",
        "john_doe",
        "password123",
      );

      userRepository.findByEmailOrUsername.mockResolvedValue(null);
      userRepository.save.mockResolvedValue();
      eventBus.publish.mockResolvedValue();
      emailService.sendEmail.mockResolvedValue();

      // Act
      const response = await useCase.execute(request);

      // Assert
      expect(response).toBeDefined();
      expect(response.userId).toBeDefined();
      expect(response.email).toBe("user@example.com");
      expect(response.username).toBe("john_doe");

      expect(userRepository.findByEmailOrUsername).toHaveBeenCalledWith(
        "user@example.com",
        "john_doe",
      );
      expect(userRepository.save).toHaveBeenCalled();
      expect(eventBus.publish).toHaveBeenCalled();
      expect(emailService.sendEmail).toHaveBeenCalled();
    });

    it("ç”¨æˆ·å·²å­˜åœ¨æ—¶åº”è¯¥æŠ›å‡ºå¼‚å¸¸", async () => {
      // Arrange
      const request = new CreateUserRequest(
        "user@example.com",
        "john_doe",
        "password123",
      );

      const existingUser = new User(
        new UserId("existing-user"),
        new Email("user@example.com"),
        new Username("john_doe"),
      );

      userRepository.findByEmailOrUsername.mockResolvedValue(existingUser);

      // Act & Assert
      await expect(useCase.execute(request)).rejects.toThrow(
        DuplicateUserException,
      );
    });

    it("è¯·æ±‚å‚æ•°æ— æ•ˆæ—¶åº”è¯¥æŠ›å‡ºå¼‚å¸¸", async () => {
      // Arrange
      const request = new CreateUserRequest("", "", "");

      // Act & Assert
      await expect(useCase.execute(request)).rejects.toThrow(
        ValidationException,
      );
    });
  });
});
```

#### 6.1.2 é›†æˆæµ‹è¯•

```typescript
/**
 * ç”¨æˆ·æ¨¡å—é›†æˆæµ‹è¯•
 *
 * @description æµ‹è¯•ç”¨æˆ·æ¨¡å—çš„é›†æˆåŠŸèƒ½
 * ç¡®ä¿å„å±‚ä¹‹é—´çš„æ­£ç¡®åä½œ
 */
describe("User Module Integration", () => {
  let app: INestApplication;
  let userRepository: IUserRepository;
  let eventBus: IEventBus;

  beforeAll(async () => {
    const moduleRef = await Test.createTestingModule({
      imports: [
        UserModule,
        DatabaseModule.forRoot({
          type: "sqlite",
          database: ":memory:",
          entities: [UserEntity],
          synchronize: true,
        }),
      ],
    }).compile();

    app = moduleRef.createNestApplication();
    await app.init();

    userRepository = moduleRef.get<IUserRepository>(IUserRepository);
    eventBus = moduleRef.get<IEventBus>(IEventBus);
  });

  afterAll(async () => {
    await app.close();
  });

  describe("ç”¨æˆ·åˆ›å»ºæµç¨‹", () => {
    it("åº”è¯¥æˆåŠŸåˆ›å»ºç”¨æˆ·å¹¶ä¿å­˜åˆ°æ•°æ®åº“", async () => {
      // Arrange
      const createUserRequest = {
        email: "user@example.com",
        username: "john_doe",
        password: "password123",
      };

      // Act
      const response = await request(app.getHttpServer())
        .post("/api/users")
        .send(createUserRequest)
        .expect(201);

      // Assert
      expect(response.body).toBeDefined();
      expect(response.body.userId).toBeDefined();
      expect(response.body.email).toBe("user@example.com");
      expect(response.body.username).toBe("john_doe");

      // éªŒè¯æ•°æ®åº“ä¸­çš„ç”¨æˆ·
      const savedUser = await userRepository.findById(
        new UserId(response.body.userId),
      );
      expect(savedUser).toBeDefined();
      expect(savedUser?.email.value).toBe("user@example.com");
    });
  });
});
```

#### 6.1.3 ç«¯åˆ°ç«¯æµ‹è¯•

```typescript
/**
 * ç”¨æˆ·ç®¡ç†ç«¯åˆ°ç«¯æµ‹è¯•
 *
 * @description æµ‹è¯•ç”¨æˆ·ç®¡ç†çš„å®Œæ•´ä¸šåŠ¡æµç¨‹
 * ç¡®ä¿ä»APIåˆ°æ•°æ®åº“çš„å®Œæ•´æµç¨‹
 */
describe("User Management E2E", () => {
  let app: INestApplication;

  beforeAll(async () => {
    const moduleRef = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleRef.createNestApplication();
    await app.init();
  });

  afterAll(async () => {
    await app.close();
  });

  describe("ç”¨æˆ·ç”Ÿå‘½å‘¨æœŸ", () => {
    it("åº”è¯¥å®Œæˆç”¨æˆ·åˆ›å»ºã€æ¿€æ´»ã€æ›´æ–°ã€åˆ é™¤çš„å®Œæ•´æµç¨‹", async () => {
      // 1. åˆ›å»ºç”¨æˆ·
      const createResponse = await request(app.getHttpServer())
        .post("/api/users")
        .send({
          email: "user@example.com",
          username: "john_doe",
          password: "password123",
        })
        .expect(201);

      const userId = createResponse.body.userId;

      // 2. æ¿€æ´»ç”¨æˆ·
      await request(app.getHttpServer())
        .put(`/api/users/${userId}/activate`)
        .expect(200);

      // 3. æ›´æ–°ç”¨æˆ·
      await request(app.getHttpServer())
        .put(`/api/users/${userId}`)
        .send({
          profile: {
            firstName: "John",
            lastName: "Doe",
          },
        })
        .expect(200);

      // 4. è·å–ç”¨æˆ·
      const getUserResponse = await request(app.getHttpServer())
        .get(`/api/users/${userId}`)
        .expect(200);

      expect(getUserResponse.body.status).toBe("ACTIVE");
      expect(getUserResponse.body.profile.firstName).toBe("John");

      // 5. åˆ é™¤ç”¨æˆ·
      await request(app.getHttpServer())
        .delete(`/api/users/${userId}`)
        .expect(200);

      // 6. éªŒè¯ç”¨æˆ·å·²åˆ é™¤
      await request(app.getHttpServer())
        .get(`/api/users/${userId}`)
        .expect(404);
    });
  });
});
```

### 6.2 æµ‹è¯•è¦†ç›–ç‡

#### 6.2.1 è¦†ç›–ç‡è¦æ±‚

- **é¢†åŸŸå±‚**: >= 90%
- **åº”ç”¨å±‚**: >= 85%
- **åŸºç¡€è®¾æ–½å±‚**: >= 80%
- **æ¥å£å±‚**: >= 75%

#### 6.2.2 æµ‹è¯•é…ç½®

```typescript
// jest.config.js
module.exports = {
  preset: "ts-jest",
  testEnvironment: "node",
  collectCoverage: true,
  coverageDirectory: "coverage",
  coverageReporters: ["text", "lcov", "html"],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80,
    },
  },
  testMatch: ["**/__tests__/**/*.test.ts", "**/?(*.)+(spec|test).ts"],
  setupFilesAfterEnv: ["<rootDir>/jest.setup.js"],
};
```

---

## 7. éƒ¨ç½²å’Œé›†æˆ

### 7.1 éƒ¨ç½²é…ç½®

#### 7.1.1 Dockeré…ç½®

```dockerfile
# Dockerfile
FROM node:20-alpine AS builder

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

FROM node:20-alpine AS runtime

WORKDIR /app
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package*.json ./

EXPOSE 3000
CMD ["node", "dist/main.js"]
```

#### 7.1.2 Docker Composeé…ç½®

```yaml
# docker-compose.yml
version: "3.8"

services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DB_HOST=postgres
      - REDIS_HOST=redis
    depends_on:
      - postgres
      - redis

  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=hl8_platform
      - POSTGRES_USER=hl8_user
      - POSTGRES_PASSWORD=hl8_password
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data

volumes:
  postgres_data:
  redis_data:
```

### 7.2 ç¯å¢ƒé…ç½®

#### 7.2.1 å¼€å‘ç¯å¢ƒ

```bash
# .env.development
NODE_ENV=development
PORT=3000
HOST=0.0.0.0

DB_HOST=localhost
DB_PORT=5432
DB_DATABASE=hl8_platform_dev
DB_USERNAME=hl8_user
DB_PASSWORD=hl8_password

REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

LOGGING_LEVEL=debug
LOGGING_PRETTY_PRINT=true
```

#### 7.2.2 ç”Ÿäº§ç¯å¢ƒ

```bash
# .env.production
NODE_ENV=production
PORT=3000
HOST=0.0.0.0

DB_HOST=postgres
DB_PORT=5432
DB_DATABASE=hl8_platform
DB_USERNAME=hl8_user
DB_PASSWORD=${DB_PASSWORD}

REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=${REDIS_PASSWORD}

LOGGING_LEVEL=info
LOGGING_PRETTY_PRINT=false
```

### 7.3 ç›‘æ§é…ç½®

#### 7.3.1 æ—¥å¿—ç›‘æ§

```typescript
// æ—¥å¿—é…ç½®
export const loggingConfig = {
  level: process.env.LOGGING_LEVEL || "info",
  prettyPrint: process.env.LOGGING_PRETTY_PRINT === "true",
  includeIsolationContext: true,
  timestamp: true,
  enabled: true,
};
```

#### 7.3.2 æ€§èƒ½ç›‘æ§

```typescript
// æ€§èƒ½ç›‘æ§é…ç½®
export const metricsConfig = {
  defaultLabels: {
    app: "hl8-platform",
    environment: process.env.NODE_ENV || "development",
  },
  includeTenantMetrics: true,
  path: "/metrics",
  enableDefaultMetrics: true,
};
```

---

## 8. æœ€ä½³å®è·µ

### 8.1 å¼€å‘æœ€ä½³å®è·µ

#### 8.1.1 ä»£ç ç»„ç»‡

- **æ¨¡å—åŒ–è®¾è®¡**: æ¯ä¸ªä¸šåŠ¡æ¨¡å—ç‹¬ç«‹å¼€å‘
- **æ¥å£ä¼˜å…ˆ**: å…ˆå®šä¹‰æ¥å£ï¼Œå†å®ç°å…·ä½“ç±»
- **ä¾èµ–æ³¨å…¥**: ä½¿ç”¨ä¾èµ–æ³¨å…¥ç®¡ç†å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ
- **é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†æœºåˆ¶

#### 8.1.2 æ€§èƒ½ä¼˜åŒ–

- **æ•°æ®åº“ä¼˜åŒ–**: åˆç†ä½¿ç”¨ç´¢å¼•ï¼Œé¿å…N+1æŸ¥è¯¢
- **ç¼“å­˜ç­–ç•¥**: åˆç†ä½¿ç”¨ç¼“å­˜ï¼Œæé«˜å“åº”é€Ÿåº¦
- **è¿æ¥æ± **: é…ç½®åˆé€‚çš„æ•°æ®åº“è¿æ¥æ± 
- **å¼‚æ­¥å¤„ç†**: ä½¿ç”¨å¼‚æ­¥å¤„ç†æé«˜å¹¶å‘æ€§èƒ½

#### 8.1.3 å®‰å…¨è€ƒè™‘

- **è¾“å…¥éªŒè¯**: ä¸¥æ ¼éªŒè¯æ‰€æœ‰è¾“å…¥å‚æ•°
- **æƒé™æ§åˆ¶**: å®ç°ç»†ç²’åº¦çš„æƒé™æ§åˆ¶
- **æ•°æ®éš”ç¦»**: ç¡®ä¿å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»
- **æ•æ„Ÿä¿¡æ¯**: ä¿æŠ¤æ•æ„Ÿä¿¡æ¯ï¼Œä½¿ç”¨åŠ å¯†å­˜å‚¨

### 8.2 æµ‹è¯•æœ€ä½³å®è·µ

#### 8.2.1 æµ‹è¯•ç­–ç•¥

- **æµ‹è¯•é‡‘å­—å¡”**: å•å…ƒæµ‹è¯• > é›†æˆæµ‹è¯• > ç«¯åˆ°ç«¯æµ‹è¯•
- **æµ‹è¯•éš”ç¦»**: æ¯ä¸ªæµ‹è¯•ç‹¬ç«‹è¿è¡Œ
- **æµ‹è¯•æ•°æ®**: ä½¿ç”¨æµ‹è¯•æ•°æ®å·¥å‚
- **æ¨¡æ‹Ÿä¾èµ–**: åˆç†ä½¿ç”¨æ¨¡æ‹Ÿå¯¹è±¡

#### 8.2.2 æµ‹è¯•è´¨é‡

- **è¦†ç›–ç‡è¦æ±‚**: è¾¾åˆ°è¦æ±‚çš„æµ‹è¯•è¦†ç›–ç‡
- **æµ‹è¯•å‘½å**: ä½¿ç”¨æè¿°æ€§çš„æµ‹è¯•åç§°
- **æµ‹è¯•ç»„ç»‡**: åˆç†ç»„ç»‡æµ‹è¯•ç»“æ„
- **æµ‹è¯•ç»´æŠ¤**: åŠæ—¶æ›´æ–°æµ‹è¯•ä»£ç 

### 8.3 éƒ¨ç½²æœ€ä½³å®è·µ

#### 8.3.1 ç¯å¢ƒç®¡ç†

- **ç¯å¢ƒéš”ç¦»**: å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒéš”ç¦»
- **é…ç½®ç®¡ç†**: ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†é…ç½®
- **å¯†é’¥ç®¡ç†**: å®‰å…¨å­˜å‚¨å’Œç®¡ç†å¯†é’¥
- **ç‰ˆæœ¬æ§åˆ¶**: ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç®¡ç†ä»£ç 

#### 8.3.2 ç›‘æ§è¿ç»´

- **æ—¥å¿—ç®¡ç†**: é›†ä¸­åŒ–æ—¥å¿—ç®¡ç†
- **æ€§èƒ½ç›‘æ§**: å®æ—¶ç›‘æ§ç³»ç»Ÿæ€§èƒ½
- **é”™è¯¯è¿½è¸ª**: åŠæ—¶è¿½è¸ªå’Œä¿®å¤é”™è¯¯
- **å®¹é‡è§„åˆ’**: åˆç†è§„åˆ’ç³»ç»Ÿå®¹é‡

---

## ğŸ“ æ€»ç»“

ä¸šåŠ¡æ¨¡å—å¼€å‘æŒ‡å—ä¸ºHL8 SAASå¹³å°çš„ä¸šåŠ¡æ¨¡å—å¼€å‘æä¾›äº†å®Œæ•´çš„æŒ‡å¯¼ã€‚é€šè¿‡éµå¾ªæ··åˆæ¶æ„æ¨¡å¼ã€ä½¿ç”¨ç»Ÿä¸€çš„åŸºç¡€è®¾æ–½ã€å®æ–½å…¨é¢çš„æµ‹è¯•ç­–ç•¥ï¼Œå¯ä»¥ç¡®ä¿ä¸šåŠ¡æ¨¡å—çš„é«˜è´¨é‡å¼€å‘å’Œéƒ¨ç½²ã€‚

è¯¥æŒ‡å—æ¶µç›–äº†ä»éœ€æ±‚åˆ†æåˆ°éƒ¨ç½²è¿ç»´çš„å®Œæ•´å¼€å‘æµç¨‹ï¼Œä¸ºå¼€å‘å›¢é˜Ÿæä¾›äº†æ¸…æ™°çš„å¼€å‘è·¯å¾„å’Œæœ€ä½³å®è·µï¼Œæ”¯æŒå¿«é€Ÿã€é«˜è´¨é‡çš„è½¯ä»¶å¼€å‘ã€‚
