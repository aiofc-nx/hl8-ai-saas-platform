# 数据隔离模块重构记录

## 📋 重构概述

将 `DataAccessDeniedEvent` 从 `events` 目录移动到 `isolation` 目录，以更好地组织数据隔离相关的代码。

## 🔄 变更内容

### 文件移动

- **原位置**: `libs/domain-kernel/src/events/data-access-denied.event.ts`
- **新位置**: `libs/domain-kernel/src/isolation/data-access-denied.event.ts`

### 文件增强

在移动过程中，对 `DataAccessDeniedEvent` 进行了增强：

1. **添加了完整的TSDoc注释**
2. **增加了业务规则说明**
3. **添加了使用示例**
4. **增加了 `toString()` 和 `toJSON()` 方法**

### 导出更新

1. **更新了 `libs/domain-kernel/src/isolation/index.ts`**：

   ```typescript
   // 事件
   export { IsolationContextCreatedEvent } from "./context-created.event.js";
   export { IsolationContextSwitchedEvent } from "./context-switched.event.js";
   export { DataAccessDeniedEvent } from "./data-access-denied.event.js"; // 新增
   ```

2. **更新了 `libs/domain-kernel/src/index.ts`**：

   ```typescript
   // 领域事件
   export { DomainEvent as DomainEventBase } from "./events/domain-event.js";
   // 注意：隔离相关事件（包括DataAccessDeniedEvent）已通过 isolation 模块导出
   ```

3. **更新了 `libs/domain-kernel/README.md`**：
   - 更新了事件列表，标注了 `DataAccessDeniedEvent` 的新位置

## 📁 当前 isolation 模块结构

```
libs/domain-kernel/src/isolation/
├── isolation-context.entity.ts          # 隔离上下文实体
├── isolation-level.enum.ts              # 隔离级别枚举
├── sharing-level.enum.ts                # 共享级别枚举
├── isolation-validation.error.ts        # 隔离验证错误
├── data-access-context.interface.ts     # 数据访问上下文接口
├── isolation-context-provider.interface.ts # 隔离上下文提供者接口
├── isolation-validator.interface.ts     # 隔离验证器接口
├── context-created.event.ts             # 上下文创建事件
├── context-switched.event.ts            # 上下文切换事件
├── data-access-denied.event.ts          # 数据访问拒绝事件（新移动）
└── index.ts                             # 统一导出文件
```

## 🎯 重构优势

### 1. **更好的代码组织**

- 所有数据隔离相关的组件现在都在同一个目录下
- 便于开发者找到和使用相关功能

### 2. **清晰的模块边界**

- `events` 目录专注于通用领域事件
- `isolation` 目录专注于数据隔离相关功能

### 3. **一致的导入路径**

- 所有隔离相关功能都通过 `@hl8/domain-kernel/isolation` 导入
- 简化了依赖管理

## 📝 使用示例

### 导入方式

```typescript
// 新的导入方式（推荐）
import {
  DataAccessDeniedEvent,
  IsolationContext,
  IsolationLevel,
} from "@hl8/domain-kernel";

// 或者直接从 isolation 模块导入
import {
  DataAccessDeniedEvent,
  IsolationContext,
  IsolationLevel,
} from "@hl8/domain-kernel/isolation";
```

### 使用示例

```typescript
// 创建数据访问拒绝事件
const event = new DataAccessDeniedEvent(
  "user-123",
  "data-456",
  "User level context cannot access organization level data",
  new Date(),
);

// 发布事件
eventBus.publish(event);

// 获取事件描述
console.log(event.toString());
// 输出: "DataAccessDeniedEvent: User user-123 denied access to data data-456. Reason: User level context cannot access organization level data"

// 获取JSON表示
console.log(event.toJSON());
// 输出: { type: 'DataAccessDeniedEvent', userId: 'user-123', dataId: 'data-456', ... }
```

## ✅ 验证结果

1. **编译通过**: 新的文件位置编译无错误
2. **导出正确**: 所有导出路径已正确更新
3. **向后兼容**: 通过 `isolation` 模块的导出保持了向后兼容性
4. **文档更新**: README 和注释已同步更新

## 🔄 后续建议

1. **考虑其他事件**: 检查是否还有其他事件应该移动到 `isolation` 目录
2. **统一命名**: 考虑将所有隔离相关的事件使用统一的命名前缀
3. **测试覆盖**: 为移动后的事件添加完整的单元测试

---

_重构完成时间：2024年1月_
