# 数据隔离表设计检查清单

## 📋 快速检查清单

### ✅ 必需字段检查

- [ ] **tenant_id** - UUID类型，NOT NULL，所有业务表必须有
- [ ] **organization_id** - UUID类型，可为NULL，组织级数据使用
- [ ] **department_id** - UUID类型，可为NULL，部门级数据使用
- [ ] **user_id** - UUID类型，可为NULL，用户级数据使用

### ✅ 审计字段检查

- [ ] **created_at** - TIMESTAMPTZ类型，NOT NULL，默认NOW()
- [ ] **updated_at** - TIMESTAMPTZ类型，NOT NULL，默认NOW()
- [ ] **deleted_at** - TIMESTAMPTZ类型，可为NULL（软删除）
- [ ] **version** - INTEGER类型，NOT NULL，默认1（乐观锁）

### ✅ 约束检查

- [ ] **层级依赖约束**：organization_id存在时tenant_id必填
- [ ] **层级依赖约束**：department_id存在时tenant_id和organization_id必填
- [ ] **唯一性约束**：租户内业务字段唯一（如email、username）
- [ ] **外键约束**：隔离字段的外键关系正确设置

### ✅ 索引检查

- [ ] **租户索引**：tenant_id字段有索引
- [ ] **组织索引**：organization_id字段有部分索引（WHERE IS NOT NULL）
- [ ] **部门索引**：department_id字段有部分索引（WHERE IS NOT NULL）
- [ ] **用户索引**：user_id字段有部分索引（WHERE IS NOT NULL）
- [ ] **复合索引**：常用查询组合有复合索引
- [ ] **软删除索引**：deleted_at字段有部分索引（WHERE IS NULL）

### ✅ 性能检查

- [ ] **查询优化**：WHERE条件优先使用隔离字段
- [ ] **索引覆盖**：关键查询有覆盖索引
- [ ] **分区策略**：大表考虑按tenant_id分区
- [ ] **统计信息**：定期更新表统计信息

### ✅ 安全检查

- [ ] **行级安全**：启用RLS策略（PostgreSQL）
- [ ] **数据加密**：敏感字段加密存储
- [ ] **权限控制**：应用层正确验证隔离上下文
- [ ] **审计日志**：记录数据访问操作

## 🚨 常见错误

### ❌ 隔离字段缺失

```sql
-- 错误：缺少隔离字段
CREATE TABLE products (
  id UUID PRIMARY KEY,
  name VARCHAR(200) NOT NULL
  -- 缺少 tenant_id 等隔离字段
);

-- 正确：包含完整隔离字段
CREATE TABLE products (
  id UUID PRIMARY KEY,
  tenant_id UUID NOT NULL,
  organization_id UUID,
  department_id UUID,
  name VARCHAR(200) NOT NULL
);
```

### ❌ 索引设计不当

```sql
-- 错误：为NULL值创建索引
CREATE INDEX idx_products_org_id ON products(organization_id);

-- 正确：使用部分索引
CREATE INDEX idx_products_org_id ON products(organization_id)
WHERE organization_id IS NOT NULL;
```

### ❌ 约束不完整

```sql
-- 错误：缺少层级依赖约束
CREATE TABLE products (
  tenant_id UUID,
  organization_id UUID,
  department_id UUID
  -- 缺少层级依赖约束
);

-- 正确：添加层级依赖约束
CREATE TABLE products (
  tenant_id UUID,
  organization_id UUID,
  department_id UUID,
  CONSTRAINT chk_org_with_tenant CHECK (
    organization_id IS NULL OR tenant_id IS NOT NULL
  ),
  CONSTRAINT chk_dept_with_org CHECK (
    department_id IS NULL OR (
      tenant_id IS NOT NULL AND organization_id IS NOT NULL
    )
  )
);
```

## 📝 设计模板

### 标准表结构模板

```sql
CREATE TABLE {table_name} (
  -- 主键
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- 多层级隔离字段（必需）
  tenant_id UUID NOT NULL,
  organization_id UUID,
  department_id UUID,
  user_id UUID,

  -- 业务字段
  {business_columns},

  -- 审计字段
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  deleted_at TIMESTAMPTZ,
  version INTEGER DEFAULT 1 NOT NULL,

  -- 约束
  CONSTRAINT chk_{table_name}_org_with_tenant CHECK (
    organization_id IS NULL OR tenant_id IS NOT NULL
  ),
  CONSTRAINT chk_{table_name}_dept_with_org CHECK (
    department_id IS NULL OR (
      tenant_id IS NOT NULL AND organization_id IS NOT NULL
    )
  )
);

-- 索引
CREATE INDEX idx_{table_name}_tenant_id ON {table_name}(tenant_id);
CREATE INDEX idx_{table_name}_organization_id ON {table_name}(organization_id)
WHERE organization_id IS NOT NULL;
CREATE INDEX idx_{table_name}_department_id ON {table_name}(department_id)
WHERE department_id IS NOT NULL;
CREATE INDEX idx_{table_name}_user_id ON {table_name}(user_id)
WHERE user_id IS NOT NULL;
CREATE INDEX idx_{table_name}_active ON {table_name}(tenant_id)
WHERE deleted_at IS NULL;
```

### 查询模板

```sql
-- 标准查询模板
SELECT * FROM {table_name}
WHERE tenant_id = $1
  AND (organization_id IS NULL OR organization_id = $2)
  AND (department_id IS NULL OR department_id = $3)
  AND (user_id IS NULL OR user_id = $4)
  AND deleted_at IS NULL;
```

---

_使用此清单确保数据隔离表设计的正确性和完整性_
