# æ•°æ®éš”ç¦»è¡¨è®¾è®¡æ£€æŸ¥æ¸…å•

## ğŸ“‹ å¿«é€Ÿæ£€æŸ¥æ¸…å•

### âœ… å¿…éœ€å­—æ®µæ£€æŸ¥

- [ ] **tenant_id** - UUIDç±»å‹ï¼ŒNOT NULLï¼Œæ‰€æœ‰ä¸šåŠ¡è¡¨å¿…é¡»æœ‰
- [ ] **organization_id** - UUIDç±»å‹ï¼Œå¯ä¸ºNULLï¼Œç»„ç»‡çº§æ•°æ®ä½¿ç”¨
- [ ] **department_id** - UUIDç±»å‹ï¼Œå¯ä¸ºNULLï¼Œéƒ¨é—¨çº§æ•°æ®ä½¿ç”¨
- [ ] **user_id** - UUIDç±»å‹ï¼Œå¯ä¸ºNULLï¼Œç”¨æˆ·çº§æ•°æ®ä½¿ç”¨

### âœ… å®¡è®¡å­—æ®µæ£€æŸ¥

- [ ] **created_at** - TIMESTAMPTZç±»å‹ï¼ŒNOT NULLï¼Œé»˜è®¤NOW()
- [ ] **updated_at** - TIMESTAMPTZç±»å‹ï¼ŒNOT NULLï¼Œé»˜è®¤NOW()
- [ ] **deleted_at** - TIMESTAMPTZç±»å‹ï¼Œå¯ä¸ºNULLï¼ˆè½¯åˆ é™¤ï¼‰
- [ ] **version** - INTEGERç±»å‹ï¼ŒNOT NULLï¼Œé»˜è®¤1ï¼ˆä¹è§‚é”ï¼‰

### âœ… çº¦æŸæ£€æŸ¥

- [ ] **å±‚çº§ä¾èµ–çº¦æŸ**ï¼šorganization_idå­˜åœ¨æ—¶tenant_idå¿…å¡«
- [ ] **å±‚çº§ä¾èµ–çº¦æŸ**ï¼šdepartment_idå­˜åœ¨æ—¶tenant_idå’Œorganization_idå¿…å¡«
- [ ] **å”¯ä¸€æ€§çº¦æŸ**ï¼šç§Ÿæˆ·å†…ä¸šåŠ¡å­—æ®µå”¯ä¸€ï¼ˆå¦‚emailã€usernameï¼‰
- [ ] **å¤–é”®çº¦æŸ**ï¼šéš”ç¦»å­—æ®µçš„å¤–é”®å…³ç³»æ­£ç¡®è®¾ç½®

### âœ… ç´¢å¼•æ£€æŸ¥

- [ ] **ç§Ÿæˆ·ç´¢å¼•**ï¼štenant_idå­—æ®µæœ‰ç´¢å¼•
- [ ] **ç»„ç»‡ç´¢å¼•**ï¼šorganization_idå­—æ®µæœ‰éƒ¨åˆ†ç´¢å¼•ï¼ˆWHERE IS NOT NULLï¼‰
- [ ] **éƒ¨é—¨ç´¢å¼•**ï¼šdepartment_idå­—æ®µæœ‰éƒ¨åˆ†ç´¢å¼•ï¼ˆWHERE IS NOT NULLï¼‰
- [ ] **ç”¨æˆ·ç´¢å¼•**ï¼šuser_idå­—æ®µæœ‰éƒ¨åˆ†ç´¢å¼•ï¼ˆWHERE IS NOT NULLï¼‰
- [ ] **å¤åˆç´¢å¼•**ï¼šå¸¸ç”¨æŸ¥è¯¢ç»„åˆæœ‰å¤åˆç´¢å¼•
- [ ] **è½¯åˆ é™¤ç´¢å¼•**ï¼šdeleted_atå­—æ®µæœ‰éƒ¨åˆ†ç´¢å¼•ï¼ˆWHERE IS NULLï¼‰

### âœ… æ€§èƒ½æ£€æŸ¥

- [ ] **æŸ¥è¯¢ä¼˜åŒ–**ï¼šWHEREæ¡ä»¶ä¼˜å…ˆä½¿ç”¨éš”ç¦»å­—æ®µ
- [ ] **ç´¢å¼•è¦†ç›–**ï¼šå…³é”®æŸ¥è¯¢æœ‰è¦†ç›–ç´¢å¼•
- [ ] **åˆ†åŒºç­–ç•¥**ï¼šå¤§è¡¨è€ƒè™‘æŒ‰tenant_idåˆ†åŒº
- [ ] **ç»Ÿè®¡ä¿¡æ¯**ï¼šå®šæœŸæ›´æ–°è¡¨ç»Ÿè®¡ä¿¡æ¯

### âœ… å®‰å…¨æ£€æŸ¥

- [ ] **è¡Œçº§å®‰å…¨**ï¼šå¯ç”¨RLSç­–ç•¥ï¼ˆPostgreSQLï¼‰
- [ ] **æ•°æ®åŠ å¯†**ï¼šæ•æ„Ÿå­—æ®µåŠ å¯†å­˜å‚¨
- [ ] **æƒé™æ§åˆ¶**ï¼šåº”ç”¨å±‚æ­£ç¡®éªŒè¯éš”ç¦»ä¸Šä¸‹æ–‡
- [ ] **å®¡è®¡æ—¥å¿—**ï¼šè®°å½•æ•°æ®è®¿é—®æ“ä½œ

## ğŸš¨ å¸¸è§é”™è¯¯

### âŒ éš”ç¦»å­—æ®µç¼ºå¤±

```sql
-- é”™è¯¯ï¼šç¼ºå°‘éš”ç¦»å­—æ®µ
CREATE TABLE products (
  id UUID PRIMARY KEY,
  name VARCHAR(200) NOT NULL
  -- ç¼ºå°‘ tenant_id ç­‰éš”ç¦»å­—æ®µ
);

-- æ­£ç¡®ï¼šåŒ…å«å®Œæ•´éš”ç¦»å­—æ®µ
CREATE TABLE products (
  id UUID PRIMARY KEY,
  tenant_id UUID NOT NULL,
  organization_id UUID,
  department_id UUID,
  name VARCHAR(200) NOT NULL
);
```

### âŒ ç´¢å¼•è®¾è®¡ä¸å½“

```sql
-- é”™è¯¯ï¼šä¸ºNULLå€¼åˆ›å»ºç´¢å¼•
CREATE INDEX idx_products_org_id ON products(organization_id);

-- æ­£ç¡®ï¼šä½¿ç”¨éƒ¨åˆ†ç´¢å¼•
CREATE INDEX idx_products_org_id ON products(organization_id)
WHERE organization_id IS NOT NULL;
```

### âŒ çº¦æŸä¸å®Œæ•´

```sql
-- é”™è¯¯ï¼šç¼ºå°‘å±‚çº§ä¾èµ–çº¦æŸ
CREATE TABLE products (
  tenant_id UUID,
  organization_id UUID,
  department_id UUID
  -- ç¼ºå°‘å±‚çº§ä¾èµ–çº¦æŸ
);

-- æ­£ç¡®ï¼šæ·»åŠ å±‚çº§ä¾èµ–çº¦æŸ
CREATE TABLE products (
  tenant_id UUID,
  organization_id UUID,
  department_id UUID,
  CONSTRAINT chk_org_with_tenant CHECK (
    organization_id IS NULL OR tenant_id IS NOT NULL
  ),
  CONSTRAINT chk_dept_with_org CHECK (
    department_id IS NULL OR (
      tenant_id IS NOT NULL AND organization_id IS NOT NULL
    )
  )
);
```

## ğŸ“ è®¾è®¡æ¨¡æ¿

### æ ‡å‡†è¡¨ç»“æ„æ¨¡æ¿

```sql
CREATE TABLE {table_name} (
  -- ä¸»é”®
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- å¤šå±‚çº§éš”ç¦»å­—æ®µï¼ˆå¿…éœ€ï¼‰
  tenant_id UUID NOT NULL,
  organization_id UUID,
  department_id UUID,
  user_id UUID,

  -- ä¸šåŠ¡å­—æ®µ
  {business_columns},

  -- å®¡è®¡å­—æ®µ
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  deleted_at TIMESTAMPTZ,
  version INTEGER DEFAULT 1 NOT NULL,

  -- çº¦æŸ
  CONSTRAINT chk_{table_name}_org_with_tenant CHECK (
    organization_id IS NULL OR tenant_id IS NOT NULL
  ),
  CONSTRAINT chk_{table_name}_dept_with_org CHECK (
    department_id IS NULL OR (
      tenant_id IS NOT NULL AND organization_id IS NOT NULL
    )
  )
);

-- ç´¢å¼•
CREATE INDEX idx_{table_name}_tenant_id ON {table_name}(tenant_id);
CREATE INDEX idx_{table_name}_organization_id ON {table_name}(organization_id)
WHERE organization_id IS NOT NULL;
CREATE INDEX idx_{table_name}_department_id ON {table_name}(department_id)
WHERE department_id IS NOT NULL;
CREATE INDEX idx_{table_name}_user_id ON {table_name}(user_id)
WHERE user_id IS NOT NULL;
CREATE INDEX idx_{table_name}_active ON {table_name}(tenant_id)
WHERE deleted_at IS NULL;
```

### æŸ¥è¯¢æ¨¡æ¿

```sql
-- æ ‡å‡†æŸ¥è¯¢æ¨¡æ¿
SELECT * FROM {table_name}
WHERE tenant_id = $1
  AND (organization_id IS NULL OR organization_id = $2)
  AND (department_id IS NULL OR department_id = $3)
  AND (user_id IS NULL OR user_id = $4)
  AND deleted_at IS NULL;
```

---

_ä½¿ç”¨æ­¤æ¸…å•ç¡®ä¿æ•°æ®éš”ç¦»è¡¨è®¾è®¡çš„æ­£ç¡®æ€§å’Œå®Œæ•´æ€§_
