# å¤šå±‚çº§æ•°æ®éš”ç¦»æ•°æ®åº“è®¾è®¡æŒ‡å—

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æ ¸å¿ƒéš”ç¦»å­—æ®µè®¾è®¡](#æ ¸å¿ƒéš”ç¦»å­—æ®µè®¾è®¡)
3. [è¡¨ç»“æ„è®¾è®¡è¦æ±‚](#è¡¨ç»“æ„è®¾è®¡è¦æ±‚)
4. [ç´¢å¼•è®¾è®¡ç­–ç•¥](#ç´¢å¼•è®¾è®¡ç­–ç•¥)
5. [çº¦æŸè®¾è®¡è§„åˆ™](#çº¦æŸè®¾è®¡è§„åˆ™)
6. [å®é™…è¡¨è®¾è®¡ç¤ºä¾‹](#å®é™…è¡¨è®¾è®¡ç¤ºä¾‹)
7. [æ€§èƒ½ä¼˜åŒ–å»ºè®®](#æ€§èƒ½ä¼˜åŒ–å»ºè®®)
8. [å®‰å…¨ç­–ç•¥è®¾è®¡](#å®‰å…¨ç­–ç•¥è®¾è®¡)
9. [æ•°æ®è¿ç§»ç­–ç•¥](#æ•°æ®è¿ç§»ç­–ç•¥)

---

## æ¦‚è¿°

å¤šå±‚çº§æ•°æ®éš”ç¦»çš„æ•°æ®åº“è®¾è®¡éœ€è¦ç¡®ä¿ä¸åŒç§Ÿæˆ·ã€ç»„ç»‡ã€éƒ¨é—¨çš„æ•°æ®å®Œå…¨åˆ†ç¦»ï¼ŒåŒæ—¶æ”¯æŒçµæ´»çš„æŸ¥è¯¢å’Œé«˜æ•ˆçš„æ•°æ®è®¿é—®ã€‚æœ¬æŒ‡å—å°†è¯¦ç»†è¯´æ˜å¦‚ä½•åœ¨æ•°æ®åº“å±‚é¢å®ç°è¿™äº›è¦æ±‚ã€‚

### è®¾è®¡åŸåˆ™

- **æ•°æ®å®Œæ•´æ€§**ï¼šç¡®ä¿éš”ç¦»å­—æ®µçš„æ•°æ®ä¸€è‡´æ€§
- **æŸ¥è¯¢æ€§èƒ½**ï¼šé€šè¿‡åˆç†çš„ç´¢å¼•è®¾è®¡ä¼˜åŒ–æŸ¥è¯¢é€Ÿåº¦
- **å®‰å…¨éš”ç¦»**ï¼šé˜²æ­¢è·¨å±‚çº§çš„æ•°æ®æ³„éœ²
- **æ‰©å±•æ€§**ï¼šæ”¯æŒæœªæ¥çš„å±‚çº§æ‰©å±•éœ€æ±‚

---

## æ ¸å¿ƒéš”ç¦»å­—æ®µè®¾è®¡

### å¿…éœ€å­—æ®µ

æ¯ä¸ªä¸šåŠ¡è¡¨éƒ½å¿…é¡»åŒ…å«ä»¥ä¸‹éš”ç¦»å­—æ®µï¼š

```sql
-- å¤šå±‚çº§éš”ç¦»å­—æ®µ
tenant_id UUID NOT NULL,           -- ç§Ÿæˆ·IDï¼ˆå¿…å¡«ï¼‰
organization_id UUID,              -- ç»„ç»‡IDï¼ˆå¯é€‰ï¼‰
department_id UUID,                -- éƒ¨é—¨IDï¼ˆå¯é€‰ï¼‰
user_id UUID,                      -- ç”¨æˆ·IDï¼ˆå¯é€‰ï¼Œç”¨äºç”¨æˆ·çº§éš”ç¦»ï¼‰
```

### å­—æ®µè¯´æ˜

| å­—æ®µå | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| `tenant_id` | UUID | âœ… | ç§Ÿæˆ·çº§éš”ç¦»çš„æ ¸å¿ƒå­—æ®µï¼Œæ‰€æœ‰ä¸šåŠ¡æ•°æ®éƒ½å¿…é¡»æœ‰ |
| `organization_id` | UUID | âŒ | ç»„ç»‡çº§éš”ç¦»å­—æ®µï¼Œå½“æ•°æ®å±äºç‰¹å®šç»„ç»‡æ—¶ä½¿ç”¨ |
| `department_id` | UUID | âŒ | éƒ¨é—¨çº§éš”ç¦»å­—æ®µï¼Œå½“æ•°æ®å±äºç‰¹å®šéƒ¨é—¨æ—¶ä½¿ç”¨ |
| `user_id` | UUID | âŒ | ç”¨æˆ·çº§éš”ç¦»å­—æ®µï¼Œå½“æ•°æ®å±äºç‰¹å®šç”¨æˆ·æ—¶ä½¿ç”¨ |

### æ•°æ®ç±»å‹é€‰æ‹©

- **UUIDç±»å‹**ï¼šæ¨èä½¿ç”¨UUIDä½œä¸ºéš”ç¦»å­—æ®µç±»å‹
  - ä¼˜ç‚¹ï¼šå…¨å±€å”¯ä¸€ã€å®‰å…¨æ€§é«˜ã€æ”¯æŒåˆ†å¸ƒå¼ç³»ç»Ÿ
  - ç¼ºç‚¹ï¼šå­˜å‚¨ç©ºé—´è¾ƒå¤§ï¼ˆ16å­—èŠ‚ï¼‰
  - æ›¿ä»£æ–¹æ¡ˆï¼šå¯ä»¥ä½¿ç”¨ULIDæˆ–è‡ªå®šä¹‰IDæ ¼å¼

---

## è¡¨ç»“æ„è®¾è®¡è¦æ±‚

### 1. æ ‡å‡†è¡¨ç»“æ„æ¨¡æ¿

```sql
-- ä¸šåŠ¡è¡¨æ ‡å‡†æ¨¡æ¿
CREATE TABLE {table_name} (
  -- ä¸»é”®
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- å¤šå±‚çº§éš”ç¦»å­—æ®µï¼ˆå¿…éœ€ï¼‰
  tenant_id UUID NOT NULL,
  organization_id UUID,
  department_id UUID,
  user_id UUID,
  
  -- ä¸šåŠ¡å­—æ®µ
  {business_columns},
  
  -- å®¡è®¡å­—æ®µ
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  deleted_at TIMESTAMPTZ,
  version INTEGER DEFAULT 1 NOT NULL,
  
  -- åˆ›å»ºè€…ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
  created_by UUID,
  updated_by UUID,
  
  -- çº¦æŸ
  CONSTRAINT chk_{table_name}_tenant_not_null CHECK (tenant_id IS NOT NULL),
  CONSTRAINT chk_{table_name}_org_with_tenant CHECK (
    organization_id IS NULL OR tenant_id IS NOT NULL
  ),
  CONSTRAINT chk_{table_name}_dept_with_org CHECK (
    department_id IS NULL OR (
      tenant_id IS NOT NULL AND organization_id IS NOT NULL
    )
  )
);
```

### 2. å±‚çº§ä¾èµ–å…³ç³»çº¦æŸ

```sql
-- ç¡®ä¿å±‚çº§ä¾èµ–å…³ç³»çš„å®Œæ•´æ€§
-- ç»„ç»‡çº§æ•°æ®å¿…é¡»æœ‰ç§Ÿæˆ·
ALTER TABLE {table_name} ADD CONSTRAINT chk_org_with_tenant 
CHECK (organization_id IS NULL OR tenant_id IS NOT NULL);

-- éƒ¨é—¨çº§æ•°æ®å¿…é¡»æœ‰ç§Ÿæˆ·å’Œç»„ç»‡
ALTER TABLE {table_name} ADD CONSTRAINT chk_dept_with_org 
CHECK (
  department_id IS NULL OR (
    tenant_id IS NOT NULL AND organization_id IS NOT NULL
  )
);

-- ç”¨æˆ·çº§æ•°æ®å¯é€‰ç§Ÿæˆ·
ALTER TABLE {table_name} ADD CONSTRAINT chk_user_optional_tenant 
CHECK (user_id IS NULL OR tenant_id IS NULL OR tenant_id IS NOT NULL);
```

---

## ç´¢å¼•è®¾è®¡ç­–ç•¥

### 1. åŸºç¡€ç´¢å¼•

```sql
-- ç§Ÿæˆ·çº§ç´¢å¼•ï¼ˆæœ€é‡è¦ï¼ŒæŸ¥è¯¢é¢‘ç‡æœ€é«˜ï¼‰
CREATE INDEX idx_{table_name}_tenant_id ON {table_name}(tenant_id);

-- ç»„ç»‡çº§ç´¢å¼•ï¼ˆéƒ¨åˆ†ç´¢å¼•ï¼Œåªä¸ºéç©ºå€¼åˆ›å»ºï¼‰
CREATE INDEX idx_{table_name}_organization_id 
ON {table_name}(organization_id) 
WHERE organization_id IS NOT NULL;

-- éƒ¨é—¨çº§ç´¢å¼•ï¼ˆéƒ¨åˆ†ç´¢å¼•ï¼Œåªä¸ºéç©ºå€¼åˆ›å»ºï¼‰
CREATE INDEX idx_{table_name}_department_id 
ON {table_name}(department_id) 
WHERE department_id IS NOT NULL;

-- ç”¨æˆ·çº§ç´¢å¼•ï¼ˆéƒ¨åˆ†ç´¢å¼•ï¼Œåªä¸ºéç©ºå€¼åˆ›å»ºï¼‰
CREATE INDEX idx_{table_name}_user_id 
ON {table_name}(user_id) 
WHERE user_id IS NOT NULL;
```

### 2. å¤åˆç´¢å¼•

```sql
-- å±‚çº§å¤åˆç´¢å¼•ï¼ˆæŒ‰æŸ¥è¯¢é¢‘ç‡æ’åºï¼‰
CREATE INDEX idx_{table_name}_tenant_org 
ON {table_name}(tenant_id, organization_id) 
WHERE organization_id IS NOT NULL;

CREATE INDEX idx_{table_name}_tenant_org_dept 
ON {table_name}(tenant_id, organization_id, department_id) 
WHERE organization_id IS NOT NULL AND department_id IS NOT NULL;

CREATE INDEX idx_{table_name}_tenant_org_dept_user 
ON {table_name}(tenant_id, organization_id, department_id, user_id) 
WHERE organization_id IS NOT NULL AND department_id IS NOT NULL AND user_id IS NOT NULL;

-- è½¯åˆ é™¤ç´¢å¼•
CREATE INDEX idx_{table_name}_active 
ON {table_name}(tenant_id) 
WHERE deleted_at IS NULL;

-- æ›´æ–°æ—¶é—´ç´¢å¼•ï¼ˆç”¨äºå¢é‡åŒæ­¥ï¼‰
CREATE INDEX idx_{table_name}_updated_at 
ON {table_name}(updated_at) 
WHERE deleted_at IS NULL;
```

### 3. æŸ¥è¯¢ä¼˜åŒ–ç´¢å¼•

```sql
-- å¸¸ç”¨æŸ¥è¯¢ç»„åˆç´¢å¼•
CREATE INDEX idx_{table_name}_tenant_status 
ON {table_name}(tenant_id, is_active) 
WHERE deleted_at IS NULL;

CREATE INDEX idx_{table_name}_tenant_created_at 
ON {table_name}(tenant_id, created_at) 
WHERE deleted_at IS NULL;

-- å…¨æ–‡æœç´¢ç´¢å¼•ï¼ˆå¦‚æœéœ€è¦ï¼‰
CREATE INDEX idx_{table_name}_search 
ON {table_name} USING gin(to_tsvector('english', search_content));
```

---

## çº¦æŸè®¾è®¡è§„åˆ™

### 1. å”¯ä¸€æ€§çº¦æŸ

```sql
-- ç§Ÿæˆ·å†…å”¯ä¸€çº¦æŸ
ALTER TABLE {table_name} ADD CONSTRAINT uq_{table_name}_tenant_code 
UNIQUE (tenant_id, code);

-- ç»„ç»‡å†…å”¯ä¸€çº¦æŸ
ALTER TABLE {table_name} ADD CONSTRAINT uq_{table_name}_org_code 
UNIQUE (tenant_id, organization_id, code) 
WHERE organization_id IS NOT NULL;

-- éƒ¨é—¨å†…å”¯ä¸€çº¦æŸ
ALTER TABLE {table_name} ADD CONSTRAINT uq_{table_name}_dept_code 
UNIQUE (tenant_id, organization_id, department_id, code) 
WHERE organization_id IS NOT NULL AND department_id IS NOT NULL;
```

### 2. å¤–é”®çº¦æŸ

```sql
-- ç§Ÿæˆ·å¤–é”®çº¦æŸ
ALTER TABLE {table_name} ADD CONSTRAINT fk_{table_name}_tenant 
FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE;

-- ç»„ç»‡å¤–é”®çº¦æŸ
ALTER TABLE {table_name} ADD CONSTRAINT fk_{table_name}_organization 
FOREIGN KEY (organization_id) REFERENCES organizations(id) ON DELETE CASCADE;

-- éƒ¨é—¨å¤–é”®çº¦æŸ
ALTER TABLE {table_name} ADD CONSTRAINT fk_{table_name}_department 
FOREIGN KEY (department_id) REFERENCES departments(id) ON DELETE CASCADE;

-- ç”¨æˆ·å¤–é”®çº¦æŸ
ALTER TABLE {table_name} ADD CONSTRAINT fk_{table_name}_user 
FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL;
```

### 3. æ£€æŸ¥çº¦æŸ

```sql
-- ç‰ˆæœ¬å·çº¦æŸ
ALTER TABLE {table_name} ADD CONSTRAINT chk_{table_name}_version_positive 
CHECK (version > 0);

-- æ—¶é—´çº¦æŸ
ALTER TABLE {table_name} ADD CONSTRAINT chk_{table_name}_created_before_updated 
CHECK (created_at <= updated_at);

-- è½¯åˆ é™¤çº¦æŸ
ALTER TABLE {table_name} ADD CONSTRAINT chk_{table_name}_deleted_at_with_updated 
CHECK (deleted_at IS NULL OR deleted_at >= updated_at);
```

---

## å®é™…è¡¨è®¾è®¡ç¤ºä¾‹

### 1. ç”¨æˆ·è¡¨ï¼ˆUsersï¼‰

```sql
CREATE TABLE users (
  -- ä¸»é”®
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- å¤šå±‚çº§éš”ç¦»å­—æ®µ
  tenant_id UUID NOT NULL,
  organization_id UUID,
  department_id UUID,
  
  -- ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
  username VARCHAR(100) NOT NULL,
  email VARCHAR(255) NOT NULL,
  first_name VARCHAR(100) NOT NULL,
  last_name VARCHAR(100) NOT NULL,
  phone VARCHAR(20),
  
  -- çŠ¶æ€å­—æ®µ
  is_active BOOLEAN DEFAULT TRUE NOT NULL,
  email_verified BOOLEAN DEFAULT FALSE NOT NULL,
  
  -- å®¡è®¡å­—æ®µ
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  deleted_at TIMESTAMPTZ,
  version INTEGER DEFAULT 1 NOT NULL,
  
  -- çº¦æŸ
  CONSTRAINT uq_users_tenant_email UNIQUE (tenant_id, email),
  CONSTRAINT uq_users_tenant_username UNIQUE (tenant_id, username),
  CONSTRAINT chk_users_org_with_tenant CHECK (
    organization_id IS NULL OR tenant_id IS NOT NULL
  ),
  CONSTRAINT chk_users_dept_with_org CHECK (
    department_id IS NULL OR (
      tenant_id IS NOT NULL AND organization_id IS NOT NULL
    )
  ),
  CONSTRAINT chk_users_email_format CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z{},9.-]+\.[A-Za-z]{2,}$')
);

-- ç´¢å¼•
CREATE INDEX idx_users_tenant_id ON users(tenant_id);
CREATE INDEX idx_users_organization_id ON users(organization_id) WHERE organization_id IS NOT NULL;
CREATE INDEX idx_users_department_id ON users(department_id) WHERE department_id IS NOT NULL;
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_active ON users(tenant_id) WHERE deleted_at IS NULL AND is_active = TRUE;
CREATE INDEX idx_users_tenant_org ON users(tenant_id, organization_id) WHERE organization_id IS NOT NULL;
```

### 2. äº§å“è¡¨ï¼ˆProductsï¼‰

```sql
CREATE TABLE products (
  -- ä¸»é”®
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- å¤šå±‚çº§éš”ç¦»å­—æ®µ
  tenant_id UUID NOT NULL,
  organization_id UUID,
  department_id UUID,
  
  -- äº§å“ä¿¡æ¯
  name VARCHAR(200) NOT NULL,
  code VARCHAR(50) NOT NULL,
  description TEXT,
  price DECIMAL(10,2),
  currency VARCHAR(3) DEFAULT 'CNY',
  
  -- çŠ¶æ€å­—æ®µ
  status VARCHAR(20) DEFAULT 'draft' NOT NULL,
  is_active BOOLEAN DEFAULT TRUE NOT NULL,
  
  -- å®¡è®¡å­—æ®µ
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  deleted_at TIMESTAMPTZ,
  version INTEGER DEFAULT 1 NOT NULL,
  
  -- çº¦æŸ
  CONSTRAINT uq_products_tenant_code UNIQUE (tenant_id, code),
  CONSTRAINT chk_products_price_positive CHECK (price IS NULL OR price >= 0),
  CONSTRAINT chk_products_status_valid CHECK (status IN ('draft', 'active', 'inactive', 'archived'))
);

-- ç´¢å¼•
CREATE INDEX idx_products_tenant_id ON products(tenant_id);
CREATE INDEX idx_products_organization_id ON products(organization_id) WHERE organization_id IS NOT NULL;
CREATE INDEX idx_products_department_id ON products(department_id) WHERE department_id IS NOT NULL;
CREATE INDEX idx_products_code ON products(code);
CREATE INDEX idx_products_active ON products(tenant_id) WHERE deleted_at IS NULL AND is_active = TRUE;
CREATE INDEX idx_products_status ON products(tenant_id, status) WHERE deleted_at IS NULL;
```

### 3. è®¢å•è¡¨ï¼ˆOrdersï¼‰

```sql
CREATE TABLE orders (
  -- ä¸»é”®
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- å¤šå±‚çº§éš”ç¦»å­—æ®µ
  tenant_id UUID NOT NULL,
  organization_id UUID,
  department_id UUID,
  user_id UUID, -- è®¢å•å±äºç‰¹å®šç”¨æˆ·
  
  -- è®¢å•ä¿¡æ¯
  order_number VARCHAR(50) NOT NULL,
  customer_id UUID,
  total_amount DECIMAL(12,2) NOT NULL,
  currency VARCHAR(3) DEFAULT 'CNY',
  
  -- çŠ¶æ€å­—æ®µ
  status VARCHAR(20) DEFAULT 'pending' NOT NULL,
  payment_status VARCHAR(20) DEFAULT 'unpaid' NOT NULL,
  
  -- å®¡è®¡å­—æ®µ
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  deleted_at TIMESTAMPTZ,
  version INTEGER DEFAULT 1 NOT NULL,
  
  -- çº¦æŸ
  CONSTRAINT uq_orders_tenant_number UNIQUE (tenant_id, order_number),
  CONSTRAINT chk_orders_amount_positive CHECK (total_amount >= 0),
  CONSTRAINT chk_orders_status_valid CHECK (status IN ('pending', 'confirmed', 'shipped', 'delivered', 'cancelled'))
);

-- ç´¢å¼•
CREATE INDEX idx_orders_tenant_id ON orders(tenant_id);
CREATE INDEX idx_orders_organization_id ON orders(organization_id) WHERE organization_id IS NOT NULL;
CREATE INDEX idx_orders_department_id ON orders(department_id) WHERE department_id IS NOT NULL;
CREATE INDEX idx_orders_user_id ON orders(user_id) WHERE user_id IS NOT NULL;
CREATE INDEX idx_orders_customer_id ON orders(customer_id) WHERE customer_id IS NOT NULL;
CREATE INDEX idx_orders_status ON orders(tenant_id, status) WHERE deleted_at IS NULL;
CREATE INDEX idx_orders_created_at ON orders(tenant_id, created_at) WHERE deleted_at IS NULL;
```

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. åˆ†åŒºç­–ç•¥

```sql
-- æŒ‰ç§Ÿæˆ·IDåˆ†åŒºï¼ˆé€‚ç”¨äºå¤§å‹ç³»ç»Ÿï¼‰
CREATE TABLE users (
  -- è¡¨ç»“æ„...
) PARTITION BY HASH (tenant_id);

-- åˆ›å»ºåˆ†åŒº
CREATE TABLE users_p0 PARTITION OF users FOR VALUES WITH (MODULUS 4, REMAINDER 0);
CREATE TABLE users_p1 PARTITION OF users FOR VALUES WITH (MODULUS 4, REMAINDER 1);
CREATE TABLE users_p2 PARTITION OF users FOR VALUES WITH (MODULUS 4, REMAINDER 2);
CREATE TABLE users_p3 PARTITION OF users FOR VALUES WITH (MODULUS 4, REMAINDER 3);
```

### 2. æŸ¥è¯¢ä¼˜åŒ–

```sql
-- ä½¿ç”¨è¦†ç›–ç´¢å¼•é¿å…å›è¡¨
CREATE INDEX idx_users_tenant_covering 
ON users(tenant_id, organization_id, department_id) 
INCLUDE (id, username, email, is_active) 
WHERE deleted_at IS NULL;

-- ä½¿ç”¨è¡¨è¾¾å¼ç´¢å¼•
CREATE INDEX idx_users_email_lower 
ON users(lower(email));

-- ä½¿ç”¨éƒ¨åˆ†ç´¢å¼•å‡å°‘ç´¢å¼•å¤§å°
CREATE INDEX idx_users_active_tenant 
ON users(tenant_id) 
WHERE is_active = TRUE AND deleted_at IS NULL;
```

### 3. ç»Ÿè®¡ä¿¡æ¯æ›´æ–°

```sql
-- å®šæœŸæ›´æ–°ç»Ÿè®¡ä¿¡æ¯ä»¥ä¼˜åŒ–æŸ¥è¯¢è®¡åˆ’
ANALYZE users;
ANALYZE products;
ANALYZE orders;

-- è®¾ç½®è‡ªåŠ¨ç»Ÿè®¡ä¿¡æ¯æ›´æ–°
ALTER TABLE users SET (autovacuum_analyze_scale_factor = 0.01);
```

---

## å®‰å…¨ç­–ç•¥è®¾è®¡

### 1. è¡Œçº§å®‰å…¨ç­–ç•¥ï¼ˆRLSï¼‰

```sql
-- å¯ç”¨è¡Œçº§å®‰å…¨
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- åˆ›å»ºå®‰å…¨ç­–ç•¥å‡½æ•°
CREATE OR REPLACE FUNCTION get_current_tenant_id()
RETURNS UUID AS $$
BEGIN
  RETURN current_setting('app.current_tenant_id', true)::UUID;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- åˆ›å»ºç§Ÿæˆ·çº§å®‰å…¨ç­–ç•¥
CREATE POLICY tenant_isolation_policy ON users
  FOR ALL TO application_role
  USING (tenant_id = get_current_tenant_id());

-- åˆ›å»ºç»„ç»‡çº§å®‰å…¨ç­–ç•¥
CREATE POLICY organization_isolation_policy ON users
  FOR ALL TO application_role
  USING (
    tenant_id = get_current_tenant_id() AND
    (
      organization_id IS NULL OR 
      organization_id = current_setting('app.current_organization_id', true)::UUID
    )
  );
```

### 2. æ•°æ®åŠ å¯†

```sql
-- æ•æ„Ÿå­—æ®µåŠ å¯†ï¼ˆä½¿ç”¨pgcryptoæ‰©å±•ï¼‰
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- åŠ å¯†å­˜å‚¨æ•æ„Ÿä¿¡æ¯
ALTER TABLE users ADD COLUMN encrypted_phone BYTEA;
ALTER TABLE users ADD COLUMN encrypted_id_number BYTEA;

-- åˆ›å»ºåŠ å¯†å‡½æ•°
CREATE OR REPLACE FUNCTION encrypt_sensitive_data(data TEXT, key TEXT)
RETURNS BYTEA AS $$
BEGIN
  RETURN pgp_sym_encrypt(data, key);
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºè§£å¯†å‡½æ•°
CREATE OR REPLACE FUNCTION decrypt_sensitive_data(encrypted_data BYTEA, key TEXT)
RETURNS TEXT AS $$
BEGIN
  RETURN pgp_sym_decrypt(encrypted_data, key);
END;
$$ LANGUAGE plpgsql;
```

---

## æ•°æ®è¿ç§»ç­–ç•¥

### 1. å†å²æ•°æ®è¿ç§»

```sql
-- è¿ç§»è„šæœ¬æ¨¡æ¿
DO $$
DECLARE
  batch_size INTEGER := 1000;
  offset_val INTEGER := 0;
  total_count INTEGER;
BEGIN
  -- è·å–æ€»è®°å½•æ•°
  SELECT COUNT(*) INTO total_count FROM old_table;
  
  -- æ‰¹é‡è¿ç§»
  WHILE offset_val < total_count LOOP
    INSERT INTO new_table (
      id, tenant_id, organization_id, department_id,
      -- å…¶ä»–å­—æ®µ...
    )
    SELECT 
      id,
      COALESCE(tenant_id, 'default-tenant-id'),
      organization_id,
      department_id,
      -- å…¶ä»–å­—æ®µ...
    FROM old_table
    ORDER BY id
    LIMIT batch_size OFFSET offset_val;
    
    offset_val := offset_val + batch_size;
    
    -- æäº¤äº‹åŠ¡
    COMMIT;
  END LOOP;
END $$;
```

### 2. æ•°æ®éªŒè¯

```sql
-- éªŒè¯è¿ç§»å®Œæ•´æ€§
WITH migration_check AS (
  SELECT 
    COUNT(*) as old_count,
    (SELECT COUNT(*) FROM new_table) as new_count
  FROM old_table
)
SELECT 
  CASE 
    WHEN old_count = new_count THEN 'SUCCESS'
    ELSE 'FAILED'
  END as migration_status,
  old_count,
  new_count
FROM migration_check;

-- éªŒè¯éš”ç¦»å­—æ®µå®Œæ•´æ€§
SELECT 
  'tenant_id_null' as check_type,
  COUNT(*) as count
FROM new_table 
WHERE tenant_id IS NULL

UNION ALL

SELECT 
  'org_without_tenant' as check_type,
  COUNT(*) as count
FROM new_table 
WHERE organization_id IS NOT NULL AND tenant_id IS NULL;
```

---

## æœ€ä½³å®è·µæ€»ç»“

### 1. è¡¨è®¾è®¡åŸåˆ™

- âœ… **å¿…é¡»åŒ…å«éš”ç¦»å­—æ®µ**ï¼šæ¯ä¸ªä¸šåŠ¡è¡¨éƒ½è¦æœ‰å®Œæ•´çš„éš”ç¦»å­—æ®µ
- âœ… **åˆç†çš„ç´¢å¼•è®¾è®¡**ï¼šä¸ºéš”ç¦»å­—æ®µåˆ›å»ºé€‚å½“çš„ç´¢å¼•
- âœ… **çº¦æŸå®Œæ•´æ€§**ï¼šç¡®ä¿å±‚çº§ä¾èµ–å…³ç³»çš„å®Œæ•´æ€§
- âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨åˆ†åŒºã€è¦†ç›–ç´¢å¼•ç­‰ä¼˜åŒ–æŠ€æœ¯

### 2. æŸ¥è¯¢ä¼˜åŒ–åŸåˆ™

- âœ… **éš”ç¦»å­—æ®µä¼˜å…ˆ**ï¼šWHEREæ¡ä»¶ä¸­ä¼˜å…ˆä½¿ç”¨éš”ç¦»å­—æ®µ
- âœ… **é¿å…å…¨è¡¨æ‰«æ**ï¼šç¡®ä¿æŸ¥è¯¢èƒ½å¤Ÿä½¿ç”¨ç´¢å¼•
- âœ… **åˆç†ä½¿ç”¨ç¼“å­˜**ï¼šç¼“å­˜é”®è¦åŒ…å«éš”ç¦»ä¿¡æ¯
- âœ… **ç›‘æ§æŸ¥è¯¢æ€§èƒ½**ï¼šå®šæœŸåˆ†ææ…¢æŸ¥è¯¢

### 3. å®‰å…¨åŸåˆ™

- âœ… **æœ€å°æƒé™åŸåˆ™**ï¼šç”¨æˆ·åªèƒ½è®¿é—®å¿…è¦çš„æ•°æ®
- âœ… **æ•°æ®åŠ å¯†**ï¼šæ•æ„Ÿæ•°æ®è¦åŠ å¯†å­˜å‚¨
- âœ… **å®¡è®¡æ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰æ•°æ®è®¿é—®æ“ä½œ
- âœ… **æ»šçº§å®‰å…¨ç­–ç•¥**ï¼šä½¿ç”¨æ•°æ®åº“çº§åˆ«çš„å®‰å…¨ç­–ç•¥

### 4. ç»´æŠ¤åŸåˆ™

- âœ… **å®šæœŸç»´æŠ¤**ï¼šæ›´æ–°ç»Ÿè®¡ä¿¡æ¯ã€é‡å»ºç´¢å¼•
- âœ… **ç›‘æ§å‘Šè­¦**ï¼šç›‘æ§æ•°æ®åº“æ€§èƒ½å’Œé”™è¯¯
- âœ… **å¤‡ä»½ç­–ç•¥**ï¼šåˆ¶å®šå®Œæ•´çš„æ•°æ®å¤‡ä»½å’Œæ¢å¤ç­–ç•¥
- âœ… **ç‰ˆæœ¬ç®¡ç†**ï¼šä½¿ç”¨æ•°æ®åº“è¿ç§»ç®¡ç†è¡¨ç»“æ„å˜æ›´

---

## é™„å½•

### ç›¸å…³å·¥å…·

- **æ•°æ®åº“ç®¡ç†**ï¼špgAdminã€DBeaverã€DataGrip
- **æ€§èƒ½ç›‘æ§**ï¼špg_stat_statementsã€pg_stat_activity
- **å¤‡ä»½æ¢å¤**ï¼špg_dumpã€pg_restoreã€WAL-E

### ç›¸å…³æ–‡æ¡£

- [PostgreSQLå®˜æ–¹æ–‡æ¡£](https://www.postgresql.org/docs/)
- [æ•°æ®åº“æ€§èƒ½è°ƒä¼˜æŒ‡å—](./database-performance-tuning.md)
- [æ•°æ®è¿ç§»æœ€ä½³å®è·µ](./data-migration-best-practices.md)

---

*æœ€åæ›´æ–°ï¼š2024å¹´1æœˆ*
